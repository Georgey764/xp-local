--- FILE: src/app/layout.js ---
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata = {
  title: "XP Local",
  description: "Generated by create next app",
};

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
      </body>
    </html>
  );
}


--- FILE: src/app/owner/layout.js ---
import Sidebar from "./components/Sidebar";

export default function OwnerLayout({ children }) {
  return (
    <div className="flex min-h-screen bg-[oklch(99%_0.005_60)] text-[oklch(20%_0.05_260)] font-sans antialiased">
      <Sidebar />
      <main className="flex-1 p-8 lg:p-12 overflow-y-auto">
        <div className="max-w-4xl mx-auto animate-in">{children}</div>
      </main>

      <style
        dangerouslySetInnerHTML={{
          __html: `
        @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: slideIn 0.4s ease-out forwards; }
      `,
        }}
      />
    </div>
  );
}


--- FILE: src/app/owner/page.js ---
"use client";
import React, { useState } from "react";
import { ShieldCheck, Zap } from "lucide-react";
import { createClient } from "@/utils/supabase/client";

export default function RedeemPage() {
  const supabase = createClient();
  const [code, setCode] = useState("");
  const [isVerifying, setIsVerifying] = useState(false);
  const [message, setMessage] = useState({ text: "", type: "" });

  const handleVerify = async (e) => {
    e.preventDefault();
    if (code.length < 4) return;

    setIsVerifying(true);
    setMessage({ text: "", type: "" });

    try {
      // 1. Find the redemption record
      const { data: redemption, error: findError } = await supabase
        .from("redemptions")
        .select("*, rewards(label, cost)")
        .eq("code", code.toUpperCase())
        .eq("status", "active")
        .single();

      if (findError || !redemption) {
        throw new Error("Invalid or expired code.");
      }

      // 2. Mark as used
      const { error: updateError } = await supabase
        .from("redemptions")
        .update({ status: "used", redeemed_at: new Date().toISOString() })
        .eq("id", redemption.id);

      if (updateError) throw updateError;

      // 3. Log the activity for the Live Feed
      await supabase.from("activity_logs").insert([
        {
          venue_id: redemption.venue_id,
          user_id: redemption.user_id,
          action_name: redemption.rewards.label.toUpperCase(),
          xp_change: -redemption.rewards.cost,
        },
      ]);

      setMessage({
        text: `Success! ${redemption.rewards.label} Redeemed.`,
        type: "success",
      });
      setCode("");
    } catch (err) {
      setMessage({ text: err.message, type: "error" });
    } finally {
      setIsVerifying(false);
    }
  };

  return (
    <div className="max-w-md mx-auto py-10 px-6">
      <div className="text-center mb-10">
        <h1 className="text-4xl font-black italic tracking-tighter uppercase">
          Verify <span className="text-[oklch(64%_0.24_274)]">XP.</span>
        </h1>
        <p className="text-[10px] font-black uppercase tracking-widest opacity-30 mt-2">
          Enter code to deduct currency
        </p>
      </div>

      <form
        onSubmit={handleVerify}
        className="bg-white p-8 rounded-[3rem] shadow-2xl border border-neutral-50 space-y-6"
      >
        <input
          type="text"
          maxLength={6}
          placeholder="CODE"
          value={code}
          onChange={(e) => setCode(e.target.value.toUpperCase())}
          className="w-full bg-neutral-50 rounded-3xl px-8 py-6 text-3xl font-black tracking-[0.4em] text-center outline-none border-2 border-transparent focus:border-[oklch(64%_0.24_274)] transition-all"
        />

        {message.text && (
          <div
            className={`text-[11px] font-black uppercase text-center p-3 rounded-xl ${
              message.type === "success"
                ? "bg-green-50 text-green-600"
                : "bg-red-50 text-red-600"
            }`}
          >
            {message.text}
          </div>
        )}

        <button
          type="submit"
          disabled={code.length < 4 || isVerifying}
          className="w-full py-5 bg-[oklch(64%_0.24_274)] text-white rounded-2xl font-black uppercase tracking-widest shadow-xl hover:opacity-90 transition-all disabled:opacity-30 flex items-center justify-center gap-3"
        >
          {isVerifying ? (
            "Processing..."
          ) : (
            <>
              <ShieldCheck size={20} /> Verify & Deduct
            </>
          )}
        </button>
      </form>

      <div className="mt-8 bg-[oklch(64%_0.24_274)]/5 border border-[oklch(64%_0.24_274)]/10 p-6 rounded-3xl flex items-start gap-4">
        <Zap className="text-[oklch(64%_0.24_274)] shrink-0 mt-1" size={20} />
        <p className="text-[11px] font-bold opacity-60 leading-relaxed uppercase">
          Redemption records the conversion and removes XP from the customer
          wallet instantly.
        </p>
      </div>
    </div>
  );
}


--- FILE: src/app/owner/setup/page.js ---
"use client";

import React, { useState, useEffect, useCallback } from "react";
import { createClient } from "@/utils/supabase/client";
import { QRCodeSVG } from "qrcode.react";
import {
  Star,
  Instagram,
  Link as LinkIcon,
  Coffee,
  Gift,
  Trash2,
  Plus,
  Loader2,
  X,
  MessageSquare,
  Users,
  Calendar,
  Smartphone,
  Download,
  QrCode,
} from "lucide-react";

const ICON_MAP = {
  google_review: <Star size={18} />,
  ig_follow: <Instagram size={18} />,
  sms_signup: <MessageSquare size={18} />,
  referral: <Users size={18} />,
  recurring: <Calendar size={18} />,
  default: <Smartphone size={18} />,
};

export default function SetupPage() {
  const supabase = createClient();
  const [loading, setLoading] = useState(true);
  const [venueId, setVenueId] = useState(null);
  const [venueSlug, setVenueSlug] = useState("");
  const [venueName, setVenueName] = useState("");
  const [tasks, setTasks] = useState([]);
  const [rewards, setRewards] = useState([]);

  // Modal State
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [newReward, setNewReward] = useState({ label: "", cost: 500 });

  const fetchData = useCallback(async () => {
    try {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) return;

      // 1. Get Venue ID and Slug from the joined table
      const { data: staffRecord } = await supabase
        .from("venue_staff")
        .select("venue_id, venues(slug, name)")
        .eq("user_id", user.id)
        .single();

      if (staffRecord) {
        setVenueId(staffRecord.venue_id);
        setVenueSlug(staffRecord.venues.slug);
        setVenueName(staffRecord.venues.name);

        const [tasksRes, rewardsRes] = await Promise.all([
          supabase
            .from("earning_tasks")
            .select("*")
            .eq("venue_id", staffRecord.venue_id),
          supabase
            .from("rewards")
            .select("*")
            .eq("venue_id", staffRecord.venue_id),
        ]);
        setTasks(tasksRes.data || []);
        setRewards(rewardsRes.data || []);
      }
    } catch (err) {
      console.error("Error loading setup:", err);
    } finally {
      setLoading(false);
    }
  }, [supabase]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // --- QR DOWNLOAD LOGIC ---
  const downloadQR = () => {
    const svg = document.getElementById("venue-setup-qr");
    const svgData = new XMLSerializer().serializeToString(svg);
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const img = new Image();

    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      const pngFile = canvas.toDataURL("image/png");
      const downloadLink = document.createElement("a");
      downloadLink.download = `${venueSlug}-checkin-qr.png`;
      downloadLink.href = pngFile;
      downloadLink.click();
    };
    img.src = "data:image/svg+xml;base64," + btoa(svgData);
  };

  // --- DATABASE HANDLERS ---
  const updateTaskLink = async (taskId, newUrl) => {
    const { error } = await supabase
      .from("earning_tasks")
      .update({ target_url: newUrl })
      .eq("id", taskId);
    if (!error)
      setTasks(
        tasks.map((t) => (t.id === taskId ? { ...t, target_url: newUrl } : t))
      );
  };

  const handleAddReward = async (e) => {
    e.preventDefault();
    if (!newReward.label || !newReward.cost) return;
    const { data, error } = await supabase
      .from("rewards")
      .insert([
        { venue_id: venueId, label: newReward.label, cost: newReward.cost },
      ])
      .select()
      .single();
    if (!error) {
      setRewards([...rewards, data]);
      setIsModalOpen(false);
      setNewReward({ label: "", cost: 500 });
    }
  };

  const deleteReward = async (id) => {
    const { error } = await supabase.from("rewards").delete().eq("id", id);
    if (!error) setRewards(rewards.filter((r) => r.id !== id));
  };

  if (loading)
    return (
      <div className="h-screen flex items-center justify-center">
        <Loader2 className="animate-spin opacity-20" size={32} />
      </div>
    );

  const checkInUrl = `${
    typeof window !== "undefined" ? window.location.origin : ""
  }/check-in/${venueSlug}`;

  return (
    <div className="space-y-12 py-6 pb-20 animate-in fade-in duration-500 max-w-2xl mx-auto px-4">
      <header>
        <h1 className="text-3xl font-black italic tracking-tighter uppercase">
          Campaign <span className="text-[oklch(64%_0.24_274)]">Setup.</span>
        </h1>
        <p className="text-[10px] font-black uppercase tracking-widest opacity-30 mt-1">
          Configure your earning engine and inventory
        </p>
      </header>

      {/* --- STOREFRONT QR SECTION --- */}
      <section className="bg-white p-8 rounded-[3rem] border border-neutral-100 shadow-sm flex flex-col md:flex-row items-center gap-8">
        <div className="p-4 bg-neutral-50 rounded-[2rem] border-2 border-dashed border-neutral-100">
          <QRCodeSVG
            id="venue-setup-qr"
            value={checkInUrl}
            size={140}
            level={"H"}
            fgColor="#4B4ACF"
          />
        </div>
        <div className="flex-1 text-center md:text-left space-y-4">
          <div>
            <h3 className="text-lg font-black italic uppercase tracking-tight">
              Check-in <span className="text-[oklch(64%_0.24_274)]">QR.</span>
            </h3>
            <p className="text-[10px] font-bold opacity-30 uppercase tracking-widest leading-relaxed">
              Customers scan this at your counter to get recurring XP every 12
              hours.
            </p>
          </div>
          <button
            onClick={downloadQR}
            className="px-6 py-3 bg-black text-white rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center gap-2 mx-auto md:mx-0 hover:bg-neutral-800 transition-all"
          >
            <Download size={14} /> Download PNG
          </button>
        </div>
      </section>

      {/* 1. EARNING DESTINATIONS */}
      <section className="space-y-4">
        <h3 className="text-[10px] font-black uppercase tracking-[0.3em] opacity-30 px-2">
          Earning Destinations
        </h3>
        <div className="grid gap-3">
          {tasks.map((task) => (
            <div
              key={task.id}
              className="bg-white p-5 rounded-[2rem] border border-neutral-100 flex items-center gap-4 shadow-sm"
            >
              <div className="p-3 bg-neutral-50 rounded-xl text-[oklch(64%_0.24_274)]">
                {ICON_MAP[task.action_type] || ICON_MAP.default}
              </div>

              {/* If it's a recurring scan, hide the link input */}
              {task.action_type === "recurring" ? (
                <div className="flex-1">
                  <div className="text-[11px] font-black uppercase tracking-tight">
                    Physical QR Scan Only
                  </div>
                  <div className="text-[9px] font-bold opacity-30 uppercase">
                    Check-ins are managed by your printed QR code
                  </div>
                </div>
              ) : (
                <div className="flex-1 flex items-center gap-3 bg-neutral-50 px-4 py-3 rounded-xl border border-transparent focus-within:border-[oklch(64%_0.24_274)] transition-all">
                  <LinkIcon size={14} className="opacity-20" />
                  <input
                    type="url"
                    value={task.target_url || ""}
                    onChange={(e) => updateTaskLink(task.id, e.target.value)}
                    placeholder={`Paste link for ${task.label}...`}
                    className="bg-transparent text-[11px] font-bold outline-none w-full"
                  />
                </div>
              )}
            </div>
          ))}
        </div>
      </section>

      {/* 2. MARKETPLACE ITEMS */}
      <section className="space-y-4">
        <div className="flex justify-between items-center px-2">
          <h3 className="text-[10px] font-black uppercase tracking-[0.3em] opacity-30">
            Marketplace Items
          </h3>
          <button
            onClick={() => setIsModalOpen(true)}
            className="text-[10px] font-black text-[oklch(64%_0.24_274)] uppercase flex items-center gap-1 hover:opacity-70 transition-all"
          >
            <Plus size={12} /> Add Reward
          </button>
        </div>
        <div className="grid gap-3">
          {rewards.map((item) => (
            <div
              key={item.id}
              className="bg-white p-6 rounded-[2.5rem] border border-neutral-100 flex items-center justify-between group shadow-sm"
            >
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 bg-neutral-50 rounded-2xl flex items-center justify-center text-[oklch(64%_0.24_274)] group-hover:bg-[oklch(64%_0.24_274)] group-hover:text-white transition-all">
                  <Coffee size={20} />
                </div>
                <div className="font-bold text-sm tracking-tight uppercase">
                  {item.label}
                </div>
              </div>
              <div className="flex items-center gap-4">
                <span className="text-xs font-black text-[oklch(64%_0.24_274)]">
                  {item.cost} XP
                </span>
                <button
                  onClick={() => deleteReward(item.id)}
                  className="p-2 text-neutral-200 hover:text-red-500 transition-colors"
                >
                  <Trash2 size={16} />
                </button>
              </div>
            </div>
          ))}
        </div>
      </section>

      {/* ADD REWARD MODAL */}
      {isModalOpen && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/40 backdrop-blur-sm animate-in fade-in">
          <div className="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl space-y-6 relative">
            <button
              onClick={() => setIsModalOpen(false)}
              className="absolute top-6 right-6 text-neutral-300 hover:text-black"
            >
              <X size={20} />
            </button>
            <div className="text-center">
              <h2 className="text-2xl font-black italic tracking-tighter uppercase">
                New <span className="text-[oklch(64%_0.24_274)]">Reward.</span>
              </h2>
            </div>
            <form onSubmit={handleAddReward} className="space-y-4">
              <input
                autoFocus
                className="w-full bg-neutral-50 rounded-2xl p-4 text-sm font-bold outline-none border-2 border-transparent focus:border-[oklch(64%_0.24_274)]"
                placeholder="Reward Label"
                value={newReward.label}
                onChange={(e) =>
                  setNewReward({ ...newReward, label: e.target.value })
                }
              />
              <input
                type="number"
                className="w-full bg-neutral-50 rounded-2xl p-4 text-sm font-bold outline-none border-2 border-transparent focus:border-[oklch(64%_0.24_274)]"
                placeholder="XP Cost"
                value={newReward.cost}
                onChange={(e) =>
                  setNewReward({ ...newReward, cost: parseInt(e.target.value) })
                }
              />
              <button
                type="submit"
                className="w-full py-4 bg-[oklch(64%_0.24_274)] text-white rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all"
              >
                Create Item
              </button>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}


--- FILE: src/app/owner/components/Sidebar.js ---
"use client";
import React from "react";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { Zap, ShieldCheck, Activity, Settings2 } from "lucide-react";

export default function Sidebar() {
  const pathname = usePathname();

  const menu = [
    { label: "Verify Code", icon: ShieldCheck, path: "/owner" },
    { label: "Live Feed", icon: Activity, path: "/owner/feed" },
    { label: "Campaigns", icon: Settings2, path: "/owner/setup" },
  ];

  return (
    <aside className="w-64 bg-white border-r border-neutral-100 flex flex-col p-6 sticky top-0 h-screen">
      <div className="flex items-center gap-2 mb-10 px-2">
        <div className="w-8 h-8 bg-primary rounded-xl flex items-center justify-center text-white shadow-lg">
          <Zap className="w-5 h-5 fill-current" />
        </div>
        <span className="font-black text-xl uppercase italic tracking-tighter">
          XP LOCAL
        </span>
      </div>

      <nav className="space-y-1.5 flex-1">
        {menu.map((item) => (
          <Link
            key={item.path}
            href={item.path}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-2xl font-black text-[11px] uppercase tracking-widest transition-all
              ${
                pathname === item.path
                  ? "bg-primary text-white shadow-xl shadow-primary/20"
                  : "text-neutral-400 hover:bg-neutral-50 hover:text-primary"
              }`}
          >
            <item.icon size={16} />
            {item.label}
          </Link>
        ))}
      </nav>
    </aside>
  );
}


--- FILE: src/app/owner/feed/page.js ---
"use client";

import React, { useState, useEffect, useCallback } from "react";
import { createClient } from "@/utils/supabase/client";
import { formatDistanceToNow } from "date-fns";
import { Clock, Activity, ChevronDown, CheckCircle2, Zap } from "lucide-react";

export default function FeedPage() {
  const supabase = createClient();
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [visibleCount, setVisibleCount] = useState(10);
  const [totalCount, setTotalCount] = useState(0);

  // 1. Wrap fetchLogs in useCallback to fix the dependency issue
  const fetchLogs = useCallback(async () => {
    try {
      const { data, count, error } = await supabase
        .from("activity_logs")
        .select("*", { count: "exact" })
        .order("created_at", { ascending: false });

      if (error) throw error;
      setLogs(data || []);
      setTotalCount(count || 0);
    } catch (err) {
      console.error("Error fetching logs:", err.message);
    } finally {
      setLoading(false);
    }
  }, [supabase]); // fetchLogs only changes if the supabase client changes

  // 2. useEffect now safely includes fetchLogs in the dependency array
  useEffect(() => {
    fetchLogs();

    const channel = supabase
      .channel("schema-db-changes")
      .on(
        "postgres_changes",
        { event: "INSERT", schema: "public", table: "activity_logs" },
        (payload) => {
          setLogs((prev) => [payload.new, ...prev]);
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [supabase, fetchLogs]); // All dependencies are now correctly accounted for

  // 2. Calculation for Stats
  const todayEarnings = logs
    .filter(
      (log) =>
        log.xp_change > 0 &&
        new Date(log.created_at).toDateString() === new Date().toDateString()
    )
    .reduce((acc, log) => acc + log.xp_change, 0);

  const todayRedemptions = logs
    .filter(
      (log) =>
        log.xp_change < 0 &&
        new Date(log.created_at).toDateString() === new Date().toDateString()
    )
    .reduce((acc, log) => acc + Math.abs(log.xp_change), 0);

  const currentItems = logs.slice(0, visibleCount);
  const hasMore = visibleCount < logs.length;

  if (loading)
    return (
      <div className="p-10 text-center font-black italic opacity-20">
        STREAMING DATA...
      </div>
    );

  return (
    <div className="space-y-8 py-6 animate-in fade-in duration-500">
      {/* Header */}
      <div className="flex justify-between items-end px-2">
        <div>
          <h1 className="text-3xl font-black italic tracking-tighter leading-none uppercase">
            Activity <span className="text-[oklch(64%_0.24_274)]">Stream.</span>
          </h1>
          <p className="text-[10px] font-black uppercase tracking-widest opacity-30 mt-1">
            Showing {currentItems.length} of {totalCount} events
          </p>
        </div>
        <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-xl border border-neutral-100 shadow-sm">
          <div className="w-2 h-2 bg-[oklch(88%_0.19_118)] rounded-full animate-pulse" />
          <span className="text-[9px] font-black uppercase tracking-widest">
            Live Updates
          </span>
        </div>
      </div>

      {/* Main Feed Container */}
      <div className="relative bg-white rounded-[3rem] border border-neutral-100 shadow-xl shadow-neutral-100/50 overflow-hidden">
        <div className="max-h-[60vh] overflow-y-auto divide-y divide-neutral-50 scrollbar-hide">
          {currentItems.length > 0 ? (
            currentItems.map((item) => (
              <div
                key={item.id}
                className="p-6 flex items-center justify-between hover:bg-neutral-50/50 transition-colors group"
              >
                <div className="flex items-center gap-4">
                  <div className="w-12 h-12 bg-neutral-50 rounded-2xl flex items-center justify-center font-black text-[oklch(64%_0.24_274)] group-hover:bg-[oklch(64%_0.24_274)] group-hover:text-white transition-all uppercase">
                    {item.display_name ? item.display_name[0] : "?"}
                  </div>
                  <div>
                    <div className="font-black text-sm tracking-tight">
                      {item.display_name || "Guest"}
                    </div>
                    <div className="text-[10px] font-black opacity-30 uppercase tracking-widest italic">
                      {item.action_name}
                    </div>
                  </div>
                </div>
                <div className="text-right">
                  <div
                    className={`font-black text-sm ${
                      item.xp_change > 0
                        ? "text-[oklch(88%_0.19_118)]"
                        : "text-red-500"
                    }`}
                  >
                    {item.xp_change > 0 ? `+${item.xp_change}` : item.xp_change}{" "}
                    XP
                  </div>
                  <div className="text-[9px] font-bold opacity-20 uppercase flex items-center justify-end gap-1">
                    <Clock size={10} />{" "}
                    {formatDistanceToNow(new Date(item.created_at))} ago
                  </div>
                </div>
              </div>
            ))
          ) : (
            <div className="p-20 text-center text-[10px] font-black uppercase tracking-widest opacity-20">
              No activity yet
            </div>
          )}
        </div>

        {hasMore && (
          <button
            onClick={() => setVisibleCount((prev) => prev + 10)}
            className="w-full py-6 bg-neutral-50/50 hover:bg-neutral-100 border-t border-neutral-100 transition-all flex items-center justify-center gap-2 group"
          >
            <ChevronDown
              size={16}
              className="text-neutral-300 group-hover:text-primary transition-all"
            />
            <span className="text-[10px] font-black uppercase tracking-[0.2em] text-neutral-400 group-hover:text-primary">
              Load 10 More
            </span>
          </button>
        )}
      </div>

      {/* Real-time Stats */}
      <div className="grid grid-cols-2 gap-4">
        <div className="bg-white p-6 rounded-[2rem] border border-neutral-100 flex items-center justify-between shadow-sm">
          <div>
            <p className="text-[8px] font-black uppercase tracking-widest opacity-30 mb-1">
              Today&apos;s Earnings
            </p>
            <p className="text-xl font-black text-[oklch(88%_0.19_118)]">
              +{todayEarnings.toLocaleString()} XP
            </p>
          </div>
          <Activity
            size={24}
            className="text-[oklch(88%_0.19_118)] opacity-20"
          />
        </div>
        <div className="bg-white p-6 rounded-[2rem] border border-neutral-100 flex items-center justify-between shadow-sm">
          <div>
            <p className="text-[8px] font-black uppercase tracking-widest opacity-30 mb-1">
              Redemptions
            </p>
            <p className="text-xl font-black text-red-500">
              -{todayRedemptions.toLocaleString()} XP
            </p>
          </div>
          <Zap size={24} className="text-red-500 opacity-20" />
        </div>
      </div>
    </div>
  );
}


--- FILE: src/app/check-in/[venueId]/page.js ---
"use client";
import { useEffect, useState } from "react";
import { useParams } from "next/navigation";
import { createClient } from "@/utils/supabase/client";

export default function CheckInPage() {
  const { slug } = useParams();
  const supabase = createClient();
  const [status, setStatus] = useState("Verifying scan...");

  useEffect(() => {
    const processScan = async () => {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) {
        setStatus("Please sign in to claim your XP!");
        return;
      }

      const { data, error } = await supabase.rpc("claim_scan_xp", {
        user_id_input: user.id,
        venue_slug_input: slug,
      });

      if (data?.success) {
        setStatus(`Success! +${data.xp} XP added to your wallet.`);
      } else {
        setStatus("You've already scanned in the last 12 hours.");
      }
    };

    if (slug) processScan();
  }, [slug, supabase]);

  return (
    <div className="min-h-screen flex items-center justify-center p-8 text-center">
      <div className="bg-white p-10 rounded-[3rem] shadow-xl space-y-4">
        <h1 className="text-3xl font-black italic uppercase italic">
          XP <span className="text-primary">Check-in.</span>
        </h1>
        <p className="font-bold text-sm opacity-50 uppercase">{status}</p>
      </div>
    </div>
  );
}


--- FILE: src/app/page.js ---
"use client";

import React, { useState, useEffect } from "react";
import HeaderNavigation from "./components/HeaderNavigation";
import {
  Zap,
  Camera,
  MapPin,
  ChevronRight,
  ArrowRight,
  Smartphone,
  BarChart3,
  Share2,
  ShieldCheck,
  Star,
  Menu,
  X,
  Gift,
  TrendingUp,
} from "lucide-react";

const App = () => {
  const features = [
    {
      icon: <Camera className="w-6 h-6 text-[oklch(64%_0.24_274)]" />,
      title: "Social Mining Engine",
      description:
        "Automatically detect and reward customer selfies and stories. Turn diners into your 24/7 high-impact marketing team.",
    },
    {
      icon: <ShieldCheck className="w-6 h-6 text-[oklch(88%_0.19_118)]" />,
      title: "Fraud-Proof Tracking",
      description:
        "GPS-fencing and rotating QR IDs ensure rewards are only claimed by customers physically verified at your venue.",
    },
    {
      icon: <BarChart3 className="w-6 h-6 text-[oklch(84%_0.17_75)]" />,
      title: "The ROI Dashboard",
      description:
        "Track 'Customer Lifetime Value' (CLV) growth. See exactly which posts led to new walk-ins and repeat visits.",
    },
  ];

  return (
    <div className="min-h-screen bg-[var(--background)] text-[var(--foreground)] font-sans selection:bg-[oklch(88%_0.19_118)] selection:text-black antialiased">
      <HeaderNavigation />

      {/* Hero Section */}
      <section className="relative pt-32 pb-20 lg:pt-52 lg:pb-40 overflow-hidden">
        {/* Aesthetic Background Blobs using new Palette */}
        <div className="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-5xl h-full -z-10 opacity-30 pointer-events-none">
          <div className="absolute top-10 left-0 w-96 h-96 bg-[oklch(64%_0.24_274)] rounded-full mix-blend-multiply filter blur-3xl animate-blob opacity-40" />
          <div className="absolute top-20 right-0 w-96 h-96 bg-[oklch(88%_0.19_118)] rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-2000 opacity-40" />
          <div className="absolute bottom-10 left-20 w-80 h-80 bg-[oklch(84%_0.17_75)] rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-4000 opacity-40" />
        </div>

        <div className="max-w-7xl mx-auto px-6 lg:px-8">
          <div className="text-center">
            <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-[oklch(96%_0.01_60)] dark:bg-[oklch(22%_0.03_260)] border border-neutral-200 dark:border-neutral-700 text-[oklch(64%_0.24_274)] text-xs font-black mb-8 uppercase tracking-widest">
              <span className="relative flex h-2 w-2">
                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-[oklch(64%_0.24_274)] opacity-75"></span>
                <span className="relative inline-flex rounded-full h-2 w-2 bg-[oklch(64%_0.24_274)]"></span>
              </span>
              Next-Gen B2B Gamification
            </div>

            <h1 className="text-6xl lg:text-8xl font-black tracking-tight mb-8 leading-[0.9]">
              Turn your diners into <br className="hidden lg:block" />
              <span className="text-[oklch(64%_0.24_274)] underline decoration-[oklch(88%_0.19_118)] decoration-8 underline-offset-8">
                brand advocates.
              </span>
            </h1>

            <p className="max-w-2xl mx-auto text-xl lg:text-2xl opacity-70 mb-12 font-medium leading-relaxed">
              XP Local uses digital incentives and social mining to turn casual
              visits into viral growth and lifetime loyalty.
            </p>

            <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
              <button className="w-full sm:w-auto px-10 py-5 bg-[oklch(64%_0.24_274)] text-white font-black rounded-[2rem] hover:bg-[oklch(58%_0.23_274)] transition-all shadow-xl shadow-[oklch(64%_0.24_274)]/20 hover:-translate-y-1 flex items-center justify-center gap-2 group">
                Get Started Free
                <ArrowRight className="w-6 h-6 group-hover:translate-x-1 transition-transform" />
              </button>
              <button className="w-full sm:w-auto px-10 py-5 bg-[var(--background)] text-[var(--foreground)] font-black rounded-[2rem] border-2 border-neutral-200 dark:border-neutral-800 hover:border-[oklch(88%_0.19_118)] transition-all flex items-center justify-center gap-2">
                The ROI Case Study
              </button>
            </div>
          </div>
        </div>
      </section>

      {/* Social Proof / Stats */}
      <section className="py-20 border-y border-neutral-100 dark:border-neutral-800 bg-[oklch(99%_0.005_60)] dark:bg-[oklch(14%_0.02_260)]">
        <div className="max-w-7xl mx-auto px-6 lg:px-8">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-12">
            {[
              { label: "Avg. ROI", value: "4.2x" },
              { label: "UGC Growth", value: "+128%" },
              { label: "Repeat Visits", value: "+40%" },
              { label: "Zero-App Install", value: "100%" },
            ].map((stat, i) => (
              <div key={i} className="text-center">
                <div className="text-3xl lg:text-4xl font-black mb-1">
                  {stat.value}
                </div>
                <div className="text-xs font-bold opacity-40 uppercase tracking-widest">
                  {stat.label}
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* Feature Grid */}
      <section id="product" className="py-32">
        <div className="max-w-7xl mx-auto px-6 lg:px-8">
          <div className="flex flex-col md:flex-row justify-between items-end mb-20 gap-8">
            <div className="max-w-xl">
              <h2 className="text-4xl lg:text-5xl font-black mb-6 tracking-tight leading-none">
                Stop guessing. <br />
                Start gamifying.
              </h2>
              <p className="text-lg opacity-60 font-medium">
                The lightweight tech layer that helps high-aesthetic venues
                dominate social feeds and drive recurring revenue.
              </p>
            </div>
            <div className="hidden md:block">
              <button className="flex items-center gap-2 text-[oklch(64%_0.24_274)] font-black uppercase tracking-widest text-sm hover:gap-4 transition-all group">
                View platform features{" "}
                <ChevronRight
                  size={20}
                  className="group-hover:translate-x-1 transition-transform"
                />
              </button>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-10">
            {features.map((feature, idx) => (
              <div
                key={idx}
                className="group p-10 rounded-[3rem] bg-[oklch(99%_0.005_60)] dark:bg-[oklch(22%_0.03_260)] border border-transparent hover:border-[oklch(88%_0.19_118)] hover:bg-[var(--background)] hover:shadow-2xl transition-all cursor-default"
              >
                <div className="w-16 h-16 bg-[var(--background)] rounded-2xl flex items-center justify-center shadow-sm mb-8 group-hover:scale-110 group-hover:-rotate-3 transition-transform">
                  {feature.icon}
                </div>
                <h3 className="text-2xl font-black mb-4">{feature.title}</h3>
                <p className="opacity-60 leading-relaxed font-medium">
                  {feature.description}
                </p>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* Value Prop Section */}
      <section className="py-24 bg-[oklch(28%_0.04_260)] text-[oklch(99%_0.005_60)] rounded-[3rem] lg:rounded-[5rem] mx-4 lg:mx-8 mb-20 overflow-hidden relative">
        <div className="max-w-7xl mx-auto px-6 lg:px-8 py-10 relative z-10">
          <div className="grid lg:grid-cols-2 gap-20 items-center">
            <div>
              <h2 className="text-4xl lg:text-6xl font-black mb-10 leading-none">
                Low friction. <br />
                <span className="text-[oklch(88%_0.19_118)]">High impact.</span>
              </h2>
              <div className="space-y-10">
                <div className="flex gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-[oklch(64%_0.24_274)]/20 flex items-center justify-center shrink-0 border border-[oklch(64%_0.24_274)]/30">
                    <Smartphone className="text-[oklch(64%_0.24_274)]" />
                  </div>
                  <div>
                    <h4 className="text-xl font-bold mb-2">
                      Browser-Based Rewards
                    </h4>
                    <p className="opacity-50 font-medium leading-relaxed">
                      No app store downloads. Customers scan, earn, and share in
                      seconds. Lowering the barrier to entry triples adoption
                      rates.
                    </p>
                  </div>
                </div>
                <div className="flex gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-[oklch(88%_0.19_118)]/20 flex items-center justify-center shrink-0 border border-[oklch(88%_0.19_118)]/30">
                    <TrendingUp className="text-[oklch(88%_0.19_118)]" />
                  </div>
                  <div>
                    <h4 className="text-xl font-bold mb-2">Churn Guard™ AI</h4>
                    <p className="opacity-50 font-medium leading-relaxed">
                      Our ML engine identifies when a loyal regular stops coming
                      and automatically pushes a &quot;Bonus Reward&quot; to
                      their wallet.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div className="relative flex justify-center scale-90 lg:scale-100">
              {/* Mobile Phone Mockup */}
              <div className="relative w-72 h-[500px] bg-neutral-900 rounded-[3rem] border-8 border-neutral-800 shadow-2xl overflow-hidden ring-1 ring-white/10">
                <div className="h-full w-full bg-[oklch(99%_0.005_60)] flex flex-col">
                  <div className="p-6 bg-[oklch(64%_0.24_274)] text-white pt-12">
                    <p className="text-[10px] font-black uppercase tracking-widest opacity-80">
                      Rooftop Lounge XP
                    </p>
                    <p className="text-3xl font-black">Level 08</p>
                  </div>
                  <div className="p-6 flex-1">
                    <div className="mb-6">
                      <p className="text-xs font-bold text-neutral-400 mb-2 uppercase tracking-wide">
                        Rewards Progress
                      </p>
                      <div className="h-2 w-full bg-neutral-100 rounded-full overflow-hidden">
                        <div className="h-full w-3/4 bg-[oklch(88%_0.19_118)] rounded-full shadow-[0_0_15px_oklch(88%_0.19_118)]"></div>
                      </div>
                      <div className="flex justify-between mt-2">
                        <p className="text-[10px] font-bold text-neutral-400">
                          750 / 1000 XP
                        </p>
                        <p className="text-[10px] font-black text-[oklch(64%_0.24_274)] uppercase underline">
                          Claim $10
                        </p>
                      </div>
                    </div>
                    <div className="space-y-4 text-slate-900">
                      <p className="text-xs font-black uppercase tracking-widest flex items-center gap-2">
                        <Zap size={12} className="text-[oklch(64%_0.24_274)]" />{" "}
                        Daily Quests
                      </p>
                      <div className="p-4 bg-white rounded-2xl flex items-center justify-between border border-neutral-100 shadow-sm">
                        <div className="flex items-center gap-3">
                          <Camera
                            size={16}
                            className="text-[oklch(64%_0.24_274)]"
                          />
                          <span className="text-xs font-bold">
                            Post a Story
                          </span>
                        </div>
                        <span className="text-[10px] font-black text-[oklch(64%_0.24_274)]">
                          +150 XP
                        </span>
                      </div>
                      <div className="p-4 bg-white rounded-2xl flex items-center justify-between border border-neutral-100 shadow-sm opacity-60">
                        <div className="flex items-center gap-3">
                          <MapPin size={16} className="text-neutral-400" />
                          <span className="text-xs font-bold text-neutral-500">
                            Tag Location
                          </span>
                        </div>
                        <span className="text-[10px] font-black text-neutral-400">
                          Done
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {/* Floating elements */}
              <div className="absolute -top-6 -right-6 bg-[oklch(84%_0.17_75)] p-4 rounded-2xl shadow-xl transform rotate-12">
                <Gift className="text-white" />
              </div>
              <div className="absolute bottom-10 -left-10 bg-[oklch(88%_0.19_118)] p-3 rounded-xl shadow-lg transform -rotate-6">
                <Star className="text-neutral-900 fill-current" size={20} />
              </div>
            </div>
          </div>
        </div>
        {/* Glow Effects */}
        <div className="absolute -bottom-20 -right-20 w-[500px] h-[500px] bg-[oklch(64%_0.24_274)]/10 rounded-full blur-[100px]" />
      </section>

      {/* Footer */}
      <footer className="py-20 bg-[var(--background)]">
        <div className="max-w-7xl mx-auto px-6 lg:px-8">
          <div className="flex flex-col md:flex-row justify-between items-center gap-10">
            <div>
              <div className="flex items-center gap-2 mb-4 justify-center md:justify-start">
                <div className="w-8 h-8 bg-[oklch(64%_0.24_274)] rounded-lg flex items-center justify-center">
                  <Zap className="w-5 h-5 text-white fill-current" />
                </div>
                <span className="text-xl font-black tracking-tighter uppercase">
                  XP LOCAL
                </span>
              </div>
              <p className="opacity-40 font-medium text-sm text-center md:text-left">
                The gamification infrastructure for high-aesthetic hospitality.{" "}
                <br />
                Turn your physical presence into digital reach.
              </p>
            </div>
            <div className="flex flex-wrap justify-center gap-10 font-bold text-sm opacity-60">
              <a
                href="#"
                className="hover:text-[oklch(64%_0.24_274)] transition-colors"
              >
                Platform
              </a>
              <a
                href="#"
                className="hover:text-[oklch(64%_0.24_274)] transition-colors"
              >
                Privacy
              </a>
              <a
                href="#"
                className="hover:text-[oklch(64%_0.24_274)] transition-colors"
              >
                Terms
              </a>
              <a
                href="#"
                className="hover:text-[oklch(64%_0.24_274)] transition-colors"
              >
                Contact Sales
              </a>
            </div>
          </div>
          <div className="mt-16 pt-8 border-t border-neutral-100 dark:border-neutral-800 text-center text-neutral-300 text-xs font-bold uppercase tracking-[0.2em]">
            © 2025 XP Local Technologies Inc. All Rights Reserved.
          </div>
        </div>
      </footer>

      <style
        dangerouslySetInnerHTML={{
          __html: `
        @import "tailwindcss";

        @theme {
          /* Core semantic colors – gamification focused */
          --color-primary: oklch(64% 0.24 274); /* Electric violet – CTAs, progress, main actions */
          --color-primary-600: oklch(58% 0.23 274); /* Hover/active */
          --color-primary-700: oklch(50% 0.22 274); /* Darker press state */

          --color-accent: oklch(88% 0.19 118); /* Neon lime glow – badges, highlights, streaks */
          --color-accent-600: oklch(80% 0.18 118); /* Slightly muted hover */

          --color-reward: oklch(84% 0.17 75); /* Golden reward pop – achievements, +XP */
          --color-reward-600: oklch(76% 0.16 75);

          /* Neutrals */
          --color-neutral-50: oklch(99% 0.005 60); /* Almost pure white – light mode bg/cards */
          --color-neutral-100: oklch(96% 0.01 60);
          --color-neutral-200: oklch(92% 0.015 60);
          --color-neutral-800: oklch(28% 0.04 260);
          --color-neutral-950: oklch(14% 0.02 260); /* Deep slate – dark mode background */

          /* Semantic aliases */
          --color-background: var(--color-neutral-50);
          --color-foreground: oklch(20% 0.05 260);
          --color-surface: var(--color-neutral-50);
          --color-border: oklch(88% 0.015 260);
        }

        /* Dark mode adjustments */
        .dark {
          --color-background: var(--color-neutral-950);
          --color-foreground: oklch(92% 0.02 260);
          --color-surface: oklch(22% 0.03 260);
          --color-border: oklch(40% 0.03 260);

          /* Soften vivid colors */
          --color-primary: oklch(72% 0.23 274);
          --color-accent: oklch(92% 0.16 118);
          --color-reward: oklch(88% 0.16 75);
        }

        @media (prefers-color-scheme: dark) {
          :root:not(.light) {
            --color-background: var(--color-neutral-950);
            --color-foreground: oklch(92% 0.02 260);
            --color-surface: oklch(22% 0.03 260);
            --color-border: oklch(40% 0.03 260);

            --color-primary: oklch(72% 0.23 274);
            --color-accent: oklch(92% 0.16 118);
            --color-reward: oklch(88% 0.16 75);
          }
        }

        :root {
          --background: var(--color-background);
          --foreground: var(--color-foreground);
        }

        @keyframes blob {
          0% { transform: translate(0px, 0px) scale(1); }
          33% { transform: translate(30px, -50px) scale(1.1); }
          66% { transform: translate(-20px, 20px) scale(0.9); }
          100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob {
          animation: blob 10s infinite;
        }
        .animation-delay-2000 {
          animation-delay: 2s;
        }
        .animation-delay-4000 {
          animation-delay: 4s;
        }
      `,
        }}
      />
    </div>
  );
};

export default App;


--- FILE: src/app/builder-demo/page.js ---
"use client";

import { useState } from "react";

// Layout Components
import BuilderHeader from "@/components/builder-demo/BuilderHeader";
import Stepper from "@/components/builder-demo/Stepper";
import BuilderFooter from "@/components/builder-demo/BuilderFooter";

// Step Components
import StepTemplate from "@/components/builder-demo/steps/StepTemplate";
import StepLogic from "@/components/builder-demo/steps/StepLogic";
import StepTasks from "@/components/builder-demo/steps/StepTasks";
import StepRewards from "@/components/builder-demo/steps/StepRewards";
import StepReview from "@/components/builder-demo/steps/StepReview";

// Initial State constant for starting over
const INITIAL_STATE = {
  template: "",
  rewardSystem: "per-task", // Default to per-task
  selectedTasks: [],
  rewardTypes: [],
  config: {
    taskRewards: {}, // Key: TaskID, Value: Reward Config Object
    xpType: "same",
    globalXP: 10,
    rewardStructure: "single",
  },
};

export default function BuilderPage() {
  const [step, setStep] = useState(1);
  const [formData, setFormData] = useState(INITIAL_STATE);

  const steps = ["Template", "Logic", "Tasks", "Rewards", "Review"];

  // --- Handlers ---

  // Inside BuilderPage.js

  const nextStep = () => {
    // Step 2 Validation: Logic Selection
    if (step === 2 && !formData.rewardSystem) {
      alert("Please select a reward logic to continue.");
      return;
    }

    // Step 3 Validation: Task Selection
    if (step === 3 && formData.selectedTasks.length === 0) {
      alert("Please select at least one task.");
      return;
    }

    // Step 4 Validation: Reward Requirements
    if (step === 4) {
      const { selectedTasks, config } = formData;
      const taskRewards = config.taskRewards || {};

      // Check if EVERY selected task has a reward type assigned
      const allTasksHaveRewards = selectedTasks.every(
        (taskId) => taskRewards[taskId] && taskRewards[taskId].type
      );

      if (!allTasksHaveRewards) {
        alert(
          "Please assign a reward type to every selected task before continuing."
        );
        return;
      }
    }

    setStep((s) => s + 1);
  };

  const prevStep = () => setStep((s) => s - 1);

  const resetForm = () => {
    if (
      window.confirm(
        "Are you sure you want to start over? All progress will be lost."
      )
    ) {
      setFormData(INITIAL_STATE);
      setStep(1);
    }
  };

  const updateTemplate = (id) => {
    setFormData((prev) => ({ ...prev, template: id }));
    setStep(2); // Auto-advance from template selection
  };

  return (
    <div className="min-h-screen bg-background text-foreground pb-20">
      <BuilderHeader />

      <main className="max-w-4xl mx-auto px-6 py-12">
        {/* Progress Navigation */}
        <Stepper step={step} steps={steps} />

        {/* Dynamic Step Rendering */}
        <div className="mt-10 min-h-[400px]">
          {step === 1 && (
            <StepTemplate formData={formData} onSelect={updateTemplate} />
          )}

          {step === 2 && (
            <StepLogic formData={formData} setFormData={setFormData} />
          )}

          {step === 3 && (
            <StepTasks formData={formData} setFormData={setFormData} />
          )}

          {step === 4 && (
            <StepRewards formData={formData} setFormData={setFormData} />
          )}

          {step === 5 && (
            <StepReview
              formData={formData}
              setStep={setStep}
              resetForm={resetForm}
            />
          )}
        </div>

        {/* Navigation Buttons (Hidden on Template and Review) */}
        <BuilderFooter step={step} nextStep={nextStep} prevStep={prevStep} />
      </main>
    </div>
  );
}


--- FILE: src/app/owner-login/page.js ---
"use client";

import Logo from "@/components/global/Logo";
import React, { useState } from "react";
import {
  Zap,
  ArrowRight,
  Github,
  Chrome,
  ShieldCheck,
  Gift,
  Star,
  Info,
} from "lucide-react";
import { useRouter } from "next/navigation";
import { createClient } from "@/utils/supabase/client";

const Page = () => {
  const [isLoading, setIsLoading] = useState(false);
  const router = useRouter();
  const supabase = createClient();

  const handleOAuthClick = async (provider) => {
    setIsLoading(true);
    setTimeout(() => setIsLoading(false), 1000);
    console.log(`Initiating OAuth flow for: ${provider}`);
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: provider,
      options: {
        // Redirects back to your local dev environment after login
        redirectTo: `${
          window.location.origin
        }/auth/callback?next=${encodeURIComponent("/builder")}`,
      },
    });
    if (error) console.error(error);
  };

  return (
    <div className="min-h-screen bg-[var(--background)] text-[var(--foreground)] font-sans antialiased flex flex-col lg:flex-row">
      {/* Left Column: Brand & Social Proof */}
      <div className="hidden lg:flex lg:w-1/2 bg-[oklch(28%_0.04_260)] relative overflow-hidden flex-col justify-between p-12">
        {/* Animated Background Blobs using semantic theme colors */}
        <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
          <div className="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] bg-[oklch(64%_0.24_274)]/20 rounded-full blur-[120px] animate-pulse" />
          <div className="absolute bottom-[-5%] left-[-5%] w-[400px] h-[400px] bg-[oklch(88%_0.19_118)]/10 rounded-full blur-[100px]" />
        </div>

        <div className="relative z-10">
          <Logo />

          <h2 className="text-5xl font-black text-white leading-tight mb-6">
            Welcome back to the <br />
            <span className="text-[oklch(88%_0.19_118)]">Leaderboard.</span>
          </h2>
          <p className="text-xl text-slate-400 max-w-md font-medium leading-relaxed">
            Access your secure venue dashboard to track ROI, manage custom
            rewards, and monitor brand advocates.
          </p>
        </div>

        {/* Floating Reward Preview */}
        <div className="absolute bottom-40 right-10 z-20 animate-bounce transition-transform duration-1000 hidden xl:block">
          <div className="bg-[oklch(84%_0.17_75)] p-4 rounded-2xl shadow-2xl rotate-12">
            <Gift className="text-white" size={24} />
          </div>
        </div>

        <div className="relative z-10 mt-auto bg-white/5 backdrop-blur-md border border-white/10 p-8 rounded-[2.5rem]">
          <div className="flex items-center gap-4 mb-4">
            <div className="flex -space-x-3">
              {[1, 2, 3].map((i) => (
                <div
                  key={i}
                  className="w-10 h-10 rounded-full border-2 border-[oklch(28%_0.04_260)] bg-slate-700 overflow-hidden"
                >
                  <img
                    src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${
                      i + 25
                    }`}
                    alt="User"
                  />
                </div>
              ))}
            </div>
            <p className="text-sm font-bold text-white">
              Trusted by 500+ premium venues
            </p>
          </div>
          <p className="text-slate-300 italic font-medium leading-relaxed">
            &quot;The data-driven insights from XP Local changed how we think
            about loyalty. Our organic social reach has never been higher.&quot;
          </p>
          <div className="flex items-center justify-between mt-4">
            <p className="text-[oklch(88%_0.19_118)] text-sm font-black uppercase tracking-widest">
              — Sunset Bistro
            </p>
            <div className="flex gap-1 text-[oklch(84%_0.17_75)]">
              <Star size={12} fill="currentColor" />
              <Star size={12} fill="currentColor" />
              <Star size={12} fill="currentColor" />
              <Star size={12} fill="currentColor" />
              <Star size={12} fill="currentColor" />
            </div>
          </div>
        </div>
      </div>

      {/* Right Column: OAuth Login Interface */}
      <div className="flex-1 flex flex-col justify-center p-6 sm:p-12 lg:p-24 relative">
        <div className="max-w-md w-full mx-auto">
          {/* Mobile Logo Only */}
          <div
            onClick={() => {
              router.push("/");
            }}
            className="cursor-pointer lg:hidden flex items-center gap-2 mb-12"
          >
            <div className="w-8 h-8 bg-[oklch(64%_0.24_274)] rounded-lg flex items-center justify-center shadow-lg">
              <Zap className="w-4 h-4 text-white fill-current" />
            </div>
            <span className="text-xl font-black tracking-tighter">
              XP<span className="text-[oklch(64%_0.24_274)]">LOCAL</span>
            </span>
          </div>

          <div className="mb-12">
            <h1 className="text-4xl font-black mb-3 tracking-tight">
              Partner Sign In
            </h1>
            <p className="opacity-60 font-medium text-lg leading-relaxed">
              For your security, we use verified social authentication to manage
              your venue.
            </p>
          </div>

          <div className="space-y-4">
            {/* Google OAuth Button */}
            <button
              onClick={() => handleOAuthClick("google")}
              disabled={isLoading}
              className="w-full group flex items-center justify-between px-8 py-5 bg-white dark:bg-[oklch(22%_0.03_260)] border-2 border-neutral-100 dark:border-neutral-800 rounded-[2rem] hover:border-[oklch(64%_0.24_274)] transition-all active:scale-[0.98] disabled:opacity-50"
            >
              <div className="flex items-center gap-4">
                <Chrome size={24} className="text-[oklch(64%_0.24_274)]" />
                <span className="font-black text-lg">Continue with Google</span>
              </div>
              <ArrowRight className="w-5 h-5 opacity-0 group-hover:opacity-100 group-hover:translate-x-1 transition-all" />
            </button>
          </div>

          {/* <div className="mt-12 p-6 bg-[oklch(96%_0.01_60)] dark:bg-[oklch(22%_0.03_260)] rounded-3xl border border-neutral-100 dark:border-neutral-800 flex gap-4">
            <Info className="text-[oklch(64%_0.24_274)] shrink-0" size={20} />
            <p className="text-sm font-medium opacity-60 leading-relaxed">
              If you already have an account, your data will be automatically
              synced. New to XP Local?
              <a
                href="/owner-register"
                className="ml-1 text-[oklch(64%_0.24_274)] font-black hover:underline underline-offset-4"
              >
                Register your venue first.
              </a>
            </p>
          </div> */}

          <p className="mt-12 text-center text-xs font-bold opacity-30 uppercase tracking-[0.2em]">
            Secure B2B Portal for Partners
          </p>
        </div>

        {/* Status Bar */}
        <div className="mt-auto pt-10 text-center lg:text-left flex items-center justify-center lg:justify-start gap-4">
          <button className="inline-flex items-center gap-2 text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 transition-opacity">
            <ShieldCheck size={14} /> Encrypted Session
          </button>
          <span className="w-1 h-1 rounded-full bg-neutral-300 dark:bg-neutral-700"></span>
          <button className="text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 transition-opacity">
            Support: v2.0.4
          </button>
        </div>
      </div>

      <style
        dangerouslySetInnerHTML={{
          __html: `
        @import "tailwindcss";

        @theme {
          --color-primary: oklch(64% 0.24 274);
          --color-accent: oklch(88% 0.19 118);
          --color-reward: oklch(84% 0.17 75);
          --color-neutral-50: oklch(99% 0.005 60);
          --color-neutral-950: oklch(14% 0.02 260);

          --color-background: var(--color-neutral-50);
          --color-foreground: oklch(20% 0.05 260);
        }

        .dark {
          --color-background: var(--color-neutral-950);
          --color-foreground: oklch(92% 0.02 260);
        }

        @media (prefers-color-scheme: dark) {
          :root:not(.light) {
            --color-background: var(--color-neutral-950);
            --color-foreground: oklch(92% 0.02 260);
          }
        }

        :root {
          --background: var(--color-background);
          --foreground: var(--color-foreground);
        }

        body {
          background: var(--background);
          color: var(--foreground);
        }

        @keyframes pulse-slow {
          0%, 100% { opacity: 0.15; }
          50% { opacity: 0.25; }
        }
        .animate-pulse {
          animation: pulse-slow 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
      `,
        }}
      />
    </div>
  );
};

export default Page;


--- FILE: src/app/components/HeaderNavigation.js ---
"use client";

import {
  Menu,
  X,
  Zap,
  User,
  Shield,
  ChevronDown,
  ExternalLink,
} from "lucide-react";
import { useRouter } from "next/navigation";
import { useEffect, useState, useRef } from "react";

export default function Header() {
  const [scrolled, setScrolled] = useState(false);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [isLoginOpen, setIsLoginOpen] = useState(false);
  const router = useRouter();

  // Ref to handle the "Grace Period" timer
  const timeoutRef = useRef(null);

  useEffect(() => {
    const handleScroll = () => setScrolled(window.scrollY > 20);
    window.addEventListener("scroll", handleScroll);
    return () => window.removeEventListener("scroll", handleScroll);
  }, []);

  // --- Logic to prevent the menu from disappearing too fast ---
  const handleMouseEnter = () => {
    if (timeoutRef.current) clearTimeout(timeoutRef.current);
    setIsLoginOpen(true);
  };

  const handleMouseLeave = () => {
    // 150ms delay: if the user's mouse slips or moves between button/menu,
    // the menu stays open long enough for them to recover.
    timeoutRef.current = setTimeout(() => {
      setIsLoginOpen(false);
    }, 150);
  };

  return (
    <nav
      className={`fixed top-0 w-full z-50 transition-all duration-500 ${
        scrolled ? "py-3 px-4" : "py-6 px-6"
      }`}
    >
      <div
        className={`max-w-7xl mx-auto transition-all duration-500 rounded-2xl ${
          scrolled
            ? "bg-white/90 dark:bg-neutral-950/90 backdrop-blur-md shadow-sm border border-neutral-200/50 dark:border-neutral-800/50 px-6 py-2"
            : "bg-transparent px-0 py-0"
        }`}
      >
        <div className="flex justify-between items-center h-12">
          {/* Logo */}
          <div className="flex items-center gap-2 group cursor-pointer shrink-0">
            <div className="w-10 h-10 bg-[oklch(64%_0.24_274)] rounded-xl flex items-center justify-center transform group-hover:rotate-6 transition-all shadow-lg shadow-[oklch(64%_0.24_274)]/20">
              <Zap className="w-6 h-6 text-white fill-current" />
            </div>
            <span className="text-2xl font-black tracking-tighter">
              XP<span className="text-[oklch(64%_0.24_274)]">LOCAL</span>
            </span>
          </div>

          {/* Desktop Nav - Pill Style */}
          <div className="hidden md:flex items-center bg-neutral-100/80 dark:bg-neutral-800/80 rounded-full px-1.5 py-1 border border-neutral-200/20 shadow-inner">
            {["Product", "How it Works", "Pricing"].map((item) => (
              <a
                key={item}
                href={`#${item.toLowerCase().replace(/\s+/g, "-")}`}
                className="px-5 py-1.5 text-sm font-semibold text-neutral-600 dark:text-neutral-400 hover:text-[oklch(64%_0.24_274)] transition-all rounded-full hover:bg-white dark:hover:bg-neutral-900"
              >
                {item}
              </a>
            ))}
          </div>

          {/* Right Section: Login Dropdown */}
          <div className="hidden md:flex items-center">
            <div
              className="relative py-2" // This padding bridges the gap vertically
              onMouseEnter={handleMouseEnter}
              onMouseLeave={handleMouseLeave}
            >
              <button
                className={`flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 cursor-pointer ${
                  isLoginOpen
                    ? "bg-[oklch(64%_0.24_274)] text-white shadow-lg shadow-[oklch(64%_0.24_274)]/30"
                    : "bg-neutral-900 dark:bg-white text-white dark:text-black hover:ring-4 hover:ring-neutral-200 dark:hover:ring-neutral-800"
                }`}
                aria-expanded={isLoginOpen}
              >
                Sign In
                <ChevronDown
                  className={`w-4 h-4 transition-transform duration-500 ${
                    isLoginOpen ? "rotate-180" : ""
                  }`}
                />
              </button>

              {/* Dropdown Menu */}
              <div
                className={`absolute right-0 top-full w-72 pt-2 transition-all duration-300 origin-top-right
                  ${
                    isLoginOpen
                      ? "opacity-100 scale-100 translate-y-0 pointer-events-auto"
                      : "opacity-0 scale-95 -translate-y-2 pointer-events-none"
                  }
                `}
              >
                <div className="bg-white dark:bg-neutral-900 rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.15)] border border-neutral-200 dark:border-neutral-800 p-2 overflow-hidden">
                  {/* Customer Portal Option */}
                  <button
                    onClick={() => router.push("/customer-login")}
                    className="w-full flex items-center gap-4 p-3 hover:bg-blue-50 dark:hover:bg-blue-500/10 rounded-xl transition-all group text-left cursor-pointer"
                  >
                    <div className="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-500/20 flex items-center justify-center text-blue-600 transition-transform group-hover:scale-110">
                      <User className="w-5 h-5" />
                    </div>
                    <div className="flex-1">
                      <p className="text-sm font-bold flex items-center justify-between">
                        Customer Portal{" "}
                        <ExternalLink className="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity" />
                      </p>
                      <p className="text-xs text-neutral-500">
                        Book and manage experiences
                      </p>
                    </div>
                  </button>

                  <div className="h-px bg-neutral-100 dark:bg-neutral-800 my-1.5 mx-2" />

                  {/* Owner Dashboard Option */}
                  <button
                    onClick={() => {
                      router.push("/owner-login");
                    }}
                    className="w-full flex items-center gap-4 p-3 hover:bg-[oklch(64%_0.24_274)]/5 rounded-xl transition-all group text-left cursor-pointer"
                  >
                    <div className="w-10 h-10 rounded-lg bg-[oklch(64%_0.24_274)]/10 flex items-center justify-center text-[oklch(64%_0.24_274)] transition-transform group-hover:scale-110">
                      <Shield className="w-5 h-5" />
                    </div>
                    <div className="flex-1">
                      <p className="text-sm font-bold flex items-center justify-between">
                        Owner Dashboard{" "}
                        <ExternalLink className="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity" />
                      </p>
                      <p className="text-xs text-neutral-500">
                        Business tools & staff management
                      </p>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* Mobile Menu Trigger */}
          <button
            onClick={() => setIsMenuOpen(!isMenuOpen)}
            className="md:hidden p-2.5 rounded-xl bg-neutral-100 dark:bg-neutral-800 active:scale-90 transition-transform cursor-pointer"
          >
            {isMenuOpen ? (
              <X className="w-6 h-6" />
            ) : (
              <Menu className="w-6 h-6" />
            )}
          </button>
        </div>
      </div>

      {/* Mobile Drawer */}
      <div
        className={`md:hidden fixed inset-x-4 top-24 transition-all duration-500 ease-out ${
          isMenuOpen
            ? "opacity-100 translate-y-0 pointer-events-auto"
            : "opacity-0 -translate-y-8 pointer-events-none"
        }`}
      >
        <div className="bg-white dark:bg-neutral-900 rounded-[2.5rem] p-8 shadow-2xl border border-neutral-200 dark:border-neutral-800">
          <div className="space-y-6 mb-8 text-center md:text-left">
            {["Product", "How it Works", "Pricing"].map((item) => (
              <a
                key={item}
                href="#"
                className="block text-3xl font-black tracking-tight hover:text-[oklch(64%_0.24_274)] transition-colors"
                onClick={() => setIsMenuOpen(false)}
              >
                {item}
              </a>
            ))}
          </div>

          <div className="space-y-3 pt-6 border-t border-neutral-100 dark:border-neutral-800">
            <button className="w-full flex items-center justify-between px-6 py-5 bg-neutral-100 dark:bg-neutral-800 rounded-2xl font-bold cursor-pointer hover:bg-neutral-200 transition-colors">
              <span className="flex items-center gap-3">
                <User className="w-5 h-5" /> Customer Login
              </span>
              <ChevronDown className="-rotate-90 w-4 h-4 opacity-50" />
            </button>
            <button className="w-full flex items-center justify-between px-6 py-5 bg-[oklch(64%_0.24_274)] text-white rounded-2xl font-bold shadow-lg shadow-[oklch(64%_0.24_274)]/20 cursor-pointer hover:opacity-90 transition-opacity">
              <span className="flex items-center gap-3">
                <Shield className="w-5 h-5" /> Owner Portal
              </span>
              <ChevronDown className="-rotate-90 w-4 h-4" />
            </button>
          </div>
        </div>
      </div>
    </nav>
  );
}


--- FILE: src/app/venue/[venueId]/page.js ---
"use client";

import { useEffect, Suspense } from "react";
import { useParams, useSearchParams, useRouter } from "next/navigation";
import { createClient } from "@/utils/supabase/client";
import { Loader2 } from "lucide-react";

function ReferralLogic() {
  const { venueId } = useParams(); // Retrieves the UUID from the URL /[venueId]
  const searchParams = useSearchParams();
  const router = useRouter();
  const supabase = createClient();

  useEffect(() => {
    const processReferral = async () => {
      // 1. Ensure the venueId is present before proceeding
      if (!venueId || venueId === "undefined") return;

      const referrerId = searchParams.get("ref");

      try {
        // 2. Check if the venue exists in the database
        const { data: venue, error: vErr } = await supabase
          .from("venues")
          .select("id")
          .eq("id", venueId)
          .single();

        if (vErr || !venue) {
          console.error("Venue not found:", venueId);
          router.push("/"); // Fallback to home if invalid
          return;
        }

        // 3. Handle Referral Record if a referrer is present
        if (referrerId) {
          const {
            data: { user },
          } = await supabase.auth.getUser();

          // Only link if the visitor is logged in and not referring themselves
          if (user && user.id !== referrerId) {
            await supabase.from("referrals").upsert(
              [
                {
                  referrer_id: referrerId,
                  referred_id: user.id,
                  venue_id: venueId,
                  status: "pending",
                },
              ],
              { onConflict: "referred_id, venue_id" }
            ); //
          }
        }

        // 4. Redirect to the customer earn page using the ID
        router.push(`/${venueId}/earn`);
      } catch (err) {
        console.error("Referral processing error:", err);
        router.push("/");
      }
    };

    processReferral();
  }, [venueId, searchParams, supabase, router]);

  return (
    <div className="h-screen flex flex-col items-center justify-center space-y-4 bg-[oklch(99%_0.005_60)]">
      <div className="w-16 h-16 bg-white rounded-3xl shadow-xl flex items-center justify-center animate-bounce">
        <Loader2
          className="animate-spin text-[oklch(64%_0.24_274)]"
          size={32}
        />
      </div>
      <p className="font-black italic uppercase text-[10px] tracking-[0.3em] opacity-30">
        Verifying Invitation
      </p>
    </div>
  );
}

export default function ReferralLandingPage() {
  return (
    // Suspense is mandatory when using useSearchParams in Next.js 13+
    <Suspense fallback={null}>
      <ReferralLogic />
    </Suspense>
  );
}


--- FILE: src/app/builder/page.js ---
"use client";

import React, { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { createClient } from "@/utils/supabase/client";
import { QRCodeSVG } from "qrcode.react";
import {
  Percent,
  DollarSign,
  Gift,
  Star,
  CheckCircle2,
  Users,
  Calendar,
  Instagram,
  MessageSquare,
  Rocket,
  ArrowRight,
  ChevronLeft,
  Zap,
  Coffee,
  Sparkles,
  Plus,
  Trash2,
  Tag,
  Link as LinkIcon,
  Lock,
  ShoppingBag,
  Download,
  Loader2,
} from "lucide-react";

const TASK_REGISTRY = [
  {
    id: "recurring",
    label: "Recurring Visits",
    xp: 50,
    icon: <Calendar size={18} />,
    desc: "+50 XP",
    required: true,
  },
  {
    id: "referral",
    label: "Referral Program",
    xp: 150,
    icon: <Users size={18} />,
    desc: "+150 XP",
  },
  {
    id: "google_review",
    label: "Google Review",
    xp: 100,
    icon: <Star size={18} />,
    desc: "+100 XP",
    requiresLink: true,
    placeholder: "Google Maps Review Link",
  },
  {
    id: "sms_signup",
    label: "SMS Sign-up",
    xp: 25,
    icon: <MessageSquare size={18} />,
    desc: "+25 XP",
  },
  {
    id: "ig_follow",
    label: "IG Follow",
    xp: 25,
    icon: <Instagram size={18} />,
    desc: "+25 XP",
    requiresLink: true,
    placeholder: "Instagram Profile URL",
  },
];

const REWARD_PRESETS = [
  {
    id: "mystery_treat",
    label: "Mystery Treat",
    xpCost: 150,
    icon: <Sparkles size={14} />,
    type: "special",
  },
  {
    id: "5_off_25",
    label: "$5 Off ($25+)",
    xpCost: 500,
    icon: <DollarSign size={14} />,
    type: "fixed",
  },
  {
    id: "bogo_drink",
    label: "BOGO Drink",
    xpCost: 600,
    icon: <Coffee size={14} />,
    type: "special",
  },
  {
    id: "25_pct_order",
    label: "25% Off Order",
    xpCost: 800,
    icon: <Percent size={14} />,
    type: "pct",
  },
  {
    id: "free_item",
    label: "Free Item",
    xpCost: 800,
    icon: <Gift size={14} />,
    type: "free_item",
  },
];

export default function XPLocalBuilder() {
  const supabase = createClient();
  const router = useRouter();
  const [loading, setLoading] = useState(true);
  const [step, setStep] = useState(1);
  const [isLaunching, setIsLaunching] = useState(false);
  const [qrUrl, setQrUrl] = useState("");

  const [formData, setFormData] = useState({
    venueName: "",
    selectedTasks: ["recurring"],
    taskLinks: { google_review: "", ig_follow: "" },
    rewardCatalog: [
      {
        id: "init",
        promoId: "mystery_treat",
        label: "Mystery Treat",
        xpCost: 150,
        itemName: "",
        type: "special",
      },
    ],
  });

  // REDIRECT LOGIC
  useEffect(() => {
    const checkUserStatus = async () => {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) return setLoading(false);

      const { data: staffRecord } = await supabase
        .from("venue_staff")
        .select("venue_id")
        .eq("user_id", user.id)
        .eq("role", "admin")
        .single();

      if (staffRecord) {
        router.push("/owner");
      } else {
        setLoading(false);
      }
    };
    checkUserStatus();
  }, [supabase, router]);

  const launchEconomy = async () => {
    setIsLaunching(true);
    const {
      data: { user },
    } = await supabase.auth.getUser();
    if (!user) return alert("No active session found. Please sign in.");

    try {
      const slug = formData.venueName.toLowerCase().replace(/ /g, "-");

      const { data: venue, error: vErr } = await supabase
        .from("venues")
        .insert([
          {
            name: formData.venueName,
            slug,
            primary_color: "oklch(64% 0.24 274)",
          },
        ])
        .select()
        .single();

      if (vErr) throw vErr;

      await supabase
        .from("venue_staff")
        .insert([{ venue_id: venue.id, user_id: user.id, role: "admin" }]);

      const tasks = TASK_REGISTRY.filter((t) =>
        formData.selectedTasks.includes(t.id)
      ).map((t) => ({
        venue_id: venue.id,
        label: t.label,
        xp_reward: t.xp,
        action_type: t.id,
        target_url: formData.taskLinks[t.id],
      }));
      await supabase.from("earning_tasks").insert(tasks);

      const rewards = formData.rewardCatalog.map((r) => ({
        venue_id: venue.id,
        label:
          r.type === "free_item" ? `Free ${r.itemName || "Item"}` : r.label,
        cost: r.xpCost,
      }));
      await supabase.from("rewards").insert(rewards);

      // GENERATE QR URL
      setQrUrl(`${window.location.origin}/check-in/${slug}`);
    } catch (err) {
      alert("Error deploying: " + err.message);
    } finally {
      setIsLaunching(false);
    }
  };

  const downloadQR = () => {
    const svg = document.getElementById("venue-qr");
    const svgData = new XMLSerializer().serializeToString(svg);
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const img = new Image();
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      const pngFile = canvas.toDataURL("image/png");
      const downloadLink = document.createElement("a");
      downloadLink.download = `${formData.venueName}-QR.png`;
      downloadLink.href = pngFile;
      downloadLink.click();
    };
    img.src = "data:image/svg+xml;base64," + btoa(svgData);
  };

  if (loading)
    return (
      <div className="h-screen flex items-center justify-center font-black italic uppercase">
        Initializing Builder...
      </div>
    );

  return (
    <div className="min-h-screen bg-[oklch(99%_0.005_60)] pb-24 font-sans antialiased">
      <nav className="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-neutral-100 px-6 py-4 flex justify-between items-center">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 bg-[oklch(64%_0.24_274)] rounded-xl flex items-center justify-center text-white">
            <Zap size={20} fill="currentColor" />
          </div>
          <span className="font-black text-xl tracking-tighter uppercase italic">
            XP LOCAL
          </span>
        </div>
      </nav>

      <main className="max-w-xl mx-auto px-6 py-10">
        {/* Step Progress */}
        <div className="flex justify-center items-center gap-2 mb-12">
          {[1, 2, 3].map((num) => (
            <div
              key={num}
              className={`w-7 h-7 rounded-lg flex items-center justify-center font-black text-[10px] transition-all 
              ${
                step === num
                  ? "bg-[oklch(64%_0.24_274)] text-white shadow-lg scale-110"
                  : step > num
                  ? "bg-[oklch(88%_0.19_118)] text-black"
                  : "bg-neutral-100 text-neutral-400"
              }`}
            >
              {step > num ? <CheckCircle2 size={12} /> : num}
            </div>
          ))}
        </div>

        {/* Step 1 & 2 logic remains same... */}
        {step === 1 && (
          <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4">
            <div className="bg-white p-6 rounded-[2rem] border-2 border-[oklch(64%_0.24_274)] shadow-sm">
              <label className="text-[10px] font-black uppercase tracking-widest opacity-40 ml-2">
                Venue Name
              </label>
              <input
                type="text"
                placeholder="e.g. Cafe Local"
                value={formData.venueName}
                onChange={(e) =>
                  setFormData({ ...formData, venueName: e.target.value })
                }
                className="w-full bg-transparent text-2xl font-black italic outline-none p-2"
              />
            </div>
            <div className="space-y-3">
              {TASK_REGISTRY.map((t) => {
                const isSel = formData.selectedTasks.includes(t.id);
                return (
                  <div
                    key={t.id}
                    className={`p-4 rounded-[2rem] border-2 transition-all ${
                      isSel
                        ? "border-[oklch(88%_0.19_118)] bg-white shadow-sm"
                        : "border-transparent bg-neutral-100"
                    }`}
                  >
                    <button
                      onClick={() =>
                        !t.required &&
                        setFormData({
                          ...formData,
                          selectedTasks: isSel
                            ? formData.selectedTasks.filter((x) => x !== t.id)
                            : [...formData.selectedTasks, t.id],
                        })
                      }
                      className="w-full flex items-center gap-4 text-left"
                    >
                      <div
                        className={`p-3 rounded-xl ${
                          isSel
                            ? "bg-[oklch(64%_0.24_274)] text-white"
                            : "bg-white text-neutral-300"
                        }`}
                      >
                        {t.icon}
                      </div>
                      <div className="flex-1">
                        <div className="font-bold text-sm leading-tight">
                          {t.label}
                        </div>
                        <div className="text-[10px] font-black text-[oklch(64%_0.24_274)] uppercase tracking-widest">
                          {t.desc}
                        </div>
                      </div>
                      {isSel && (
                        <CheckCircle2
                          size={18}
                          className="text-[oklch(88%_0.19_118)]"
                        />
                      )}
                    </button>
                    {t.requiresLink && isSel && (
                      <input
                        type="url"
                        placeholder={t.placeholder}
                        value={formData.taskLinks[t.id] || ""}
                        onChange={(e) =>
                          setFormData({
                            ...formData,
                            taskLinks: {
                              ...formData.taskLinks,
                              [t.id]: e.target.value,
                            },
                          })
                        }
                        className="mt-4 w-full bg-neutral-50 p-3 rounded-xl text-[11px] font-bold border outline-none"
                      />
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {step === 2 && (
          <div className="space-y-4 animate-in zoom-in-95">
            <h2 className="text-3xl font-black italic text-center">
              Reward{" "}
              <span className="text-[oklch(64%_0.24_274)]">Marketplace.</span>
            </h2>
            {formData.rewardCatalog.map((item) => (
              <div
                key={item.id}
                className="p-6 bg-white rounded-[2.5rem] border-b-4 border-[oklch(88%_0.19_118)] shadow-sm"
              >
                <div className="flex flex-wrap gap-2 mb-4">
                  {REWARD_PRESETS.map((p) => (
                    <button
                      key={p.id}
                      onClick={() =>
                        setFormData({
                          ...formData,
                          rewardCatalog: formData.rewardCatalog.map((r) =>
                            r.id === item.id
                              ? {
                                  ...r,
                                  promoId: p.id,
                                  label: p.label,
                                  xpCost: p.xpCost,
                                  type: p.type,
                                }
                              : r
                          ),
                        })
                      }
                      className={`px-3 py-2 rounded-full border-2 text-[10px] font-black uppercase transition-all ${
                        item.promoId === p.id
                          ? "bg-[oklch(64%_0.24_274)] border-[oklch(64%_0.24_274)] text-white"
                          : "bg-neutral-50 border-neutral-100 text-neutral-400"
                      }`}
                    >
                      {p.label}
                    </button>
                  ))}
                </div>
                {item.type === "free_item" && (
                  <div className="flex items-center gap-2 bg-neutral-50 p-3 rounded-2xl border border-neutral-100 focus-within:border-[oklch(64%_0.24_274)] transition-colors">
                    <Tag size={14} className="text-[oklch(64%_0.24_274)]" />
                    <input
                      type="text"
                      placeholder="Free Item Name (e.g. Cupcake)"
                      value={item.itemName || ""}
                      onChange={(e) =>
                        setFormData({
                          ...formData,
                          rewardCatalog: formData.rewardCatalog.map((r) =>
                            r.id === item.id
                              ? { ...r, itemName: e.target.value }
                              : r
                          ),
                        })
                      }
                      className="bg-transparent text-[11px] font-bold outline-none flex-1"
                    />
                  </div>
                )}
              </div>
            ))}
            <button
              onClick={() =>
                setFormData({
                  ...formData,
                  rewardCatalog: [
                    ...formData.rewardCatalog,
                    {
                      id: Date.now(),
                      label: "New Item",
                      xpCost: 500,
                      type: "special",
                    },
                  ],
                })
              }
              className="w-full py-6 border-4 border-dashed rounded-[2.5rem] text-neutral-300 font-black uppercase text-[10px] tracking-widest"
            >
              + Add Reward
            </button>
          </div>
        )}

        {/* Step 3: Deployment & QR Code */}
        {step === 3 && (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
            {!qrUrl ? (
              <div className="bg-[oklch(28%_0.04_260)] p-12 rounded-[3.5rem] text-white shadow-2xl space-y-8 relative overflow-hidden">
                <h2 className="text-4xl font-black italic tracking-tighter leading-none">
                  Deploy <br />{" "}
                  <span className="text-[oklch(88%_0.19_118)]">Economy.</span>
                </h2>
                <button
                  onClick={launchEconomy}
                  disabled={isLaunching}
                  className="w-full py-5 bg-[oklch(64%_0.24_274)] text-white rounded-[1.5rem] font-black uppercase tracking-[0.3em] flex items-center justify-center gap-3 shadow-xl hover:-translate-y-1 transition-all"
                >
                  {isLaunching ? (
                    <Loader2 className="animate-spin" />
                  ) : (
                    <Rocket size={18} />
                  )}{" "}
                  Launch Platform
                </button>
              </div>
            ) : (
              <div className="bg-white p-10 rounded-[3.5rem] border border-neutral-100 shadow-2xl text-center space-y-8 animate-in zoom-in-95">
                <div className="flex flex-col items-center gap-2">
                  <div className="w-12 h-12 bg-[oklch(88%_0.19_118)] rounded-full flex items-center justify-center text-black mb-2">
                    <CheckCircle2 size={24} />
                  </div>
                  <h2 className="text-3xl font-black italic tracking-tighter uppercase">
                    Platform{" "}
                    <span className="text-[oklch(64%_0.24_274)]">Live.</span>
                  </h2>
                </div>
                <div className="p-6 bg-neutral-50 rounded-[2.5rem] inline-block border-4 border-dashed border-neutral-100">
                  <QRCodeSVG
                    id="venue-qr"
                    value={qrUrl}
                    size={200}
                    level={"H"}
                    includeMargin={true}
                    fgColor="#4B4ACF"
                  />
                </div>
                <div className="grid gap-3">
                  <button
                    onClick={downloadQR}
                    className="w-full py-5 bg-black text-white rounded-2xl font-black uppercase tracking-widest flex items-center justify-center gap-3 shadow-lg"
                  >
                    <Download size={18} /> Download QR Code
                  </button>
                  <button
                    onClick={() => router.push("/owner")}
                    className="w-full py-5 border-2 border-neutral-100 rounded-2xl font-black uppercase tracking-widest flex items-center justify-center gap-3 hover:bg-neutral-50 transition-all text-neutral-400"
                  >
                    Go to Dashboard <ArrowRight size={18} />
                  </button>
                </div>
              </div>
            )}
          </div>
        )}

        <div className="mt-12 flex justify-between p-3 bg-white/60 backdrop-blur-md rounded-[2rem] shadow-xl border border-neutral-100">
          <button
            onClick={() => setStep((s) => s - 1)}
            disabled={step === 1 || !!qrUrl}
            className="px-6 py-3 text-[10px] font-black uppercase text-neutral-400 disabled:opacity-0"
          >
            Back
          </button>
          {step < 3 && (
            <button
              onClick={() => setStep((s) => s + 1)}
              disabled={step === 1 && !formData.venueName}
              className="px-10 py-4 bg-[oklch(64%_0.24_274)] text-white rounded-2xl font-black uppercase tracking-widest shadow-lg"
            >
              Next
            </button>
          )}
        </div>
      </main>
    </div>
  );
}


--- FILE: src/app/customer-login/page.js ---
"use client";

import React, { useState } from "react";
import {
  Zap,
  ArrowRight,
  Github,
  Chrome,
  ShieldCheck,
  Gift,
  Star,
  Info,
} from "lucide-react";
import { useRouter } from "next/navigation";
import { createClient } from "@/utils/supabase/client";

const App = () => {
  const [isLoading, setIsLoading] = useState(false);
  const router = useRouter();

  const supabase = createClient();

  const handleOAuthClick = async (provider) => {
    setIsLoading(true);
    setTimeout(() => setIsLoading(false), 1000);
    console.log(`Initiating OAuth flow for: ${provider}`);
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: provider,
      options: {
        // Redirects back to your local dev environment after login
        redirectTo: `${
          window.location.origin
        }/auth/callback?next=${encodeURIComponent("/customer")}`,
      },
    });
    if (error) console.error(error);
  };

  return (
    <div className="min-h-screen bg-[var(--background)] text-[var(--foreground)] font-sans antialiased flex flex-col lg:flex-row">
      {/* Left Column: Brand & Social Proof */}
      <div className="hidden lg:flex lg:w-1/2 bg-[oklch(28%_0.04_260)] relative overflow-hidden flex-col justify-between p-12">
        {/* Animated Background Blobs using semantic theme colors */}
        <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
          <div className="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] bg-[oklch(64%_0.24_274)]/20 rounded-full blur-[120px] animate-pulse" />
          <div className="absolute bottom-[-5%] left-[-5%] w-[400px] h-[400px] bg-[oklch(88%_0.19_118)]/10 rounded-full blur-[100px]" />
        </div>

        <div className="relative z-10">
          <div
            onClick={() => {
              router.push("/");
            }}
            className="cursor-pointer flex items-center gap-2 mb-12"
          >
            <div className="w-10 h-10 bg-[oklch(64%_0.24_274)] rounded-xl flex items-center justify-center shadow-lg shadow-primary/20">
              <Zap className="w-6 h-6 text-white fill-current" />
            </div>
            <span className="text-2xl font-black tracking-tighter text-white">
              XP<span className="text-[oklch(64%_0.24_274)]">LOCAL</span>
            </span>
          </div>

          <h2 className="text-5xl font-black text-white leading-tight mb-6">
            Welcome back to the <br />
            <span className="text-[oklch(88%_0.19_118)]">Leaderboard.</span>
          </h2>
          <p className="text-xl text-slate-400 max-w-md font-medium leading-relaxed">
            Access your secure venue dashboard to track ROI, manage custom
            rewards, and monitor brand advocates.
          </p>
        </div>

        {/* Floating Reward Preview */}
        <div className="absolute bottom-40 right-10 z-20 animate-bounce transition-transform duration-1000 hidden xl:block">
          <div className="bg-[oklch(84%_0.17_75)] p-4 rounded-2xl shadow-2xl rotate-12">
            <Gift className="text-white" size={24} />
          </div>
        </div>

        <div className="relative z-10 mt-auto bg-white/5 backdrop-blur-md border border-white/10 p-8 rounded-[2.5rem]">
          <div className="flex items-center gap-4 mb-4">
            <div className="flex -space-x-3">
              {[1, 2, 3].map((i) => (
                <div
                  key={i}
                  className="w-10 h-10 rounded-full border-2 border-[oklch(28%_0.04_260)] bg-slate-700 overflow-hidden"
                >
                  <img
                    src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${
                      i + 25
                    }`}
                    alt="User"
                  />
                </div>
              ))}
            </div>
            <p className="text-sm font-bold text-white">
              Trusted by 500+ premium venues
            </p>
          </div>
          <p className="text-slate-300 italic font-medium leading-relaxed">
            &quot;The data-driven insights from XP Local changed how we think
            about loyalty. Our organic social reach has never been higher.&quot;
          </p>
          <div className="flex items-center justify-between mt-4">
            <p className="text-[oklch(88%_0.19_118)] text-sm font-black uppercase tracking-widest">
              — Sunset Bistro
            </p>
            <div className="flex gap-1 text-[oklch(84%_0.17_75)]">
              <Star size={12} fill="currentColor" />
              <Star size={12} fill="currentColor" />
              <Star size={12} fill="currentColor" />
              <Star size={12} fill="currentColor" />
              <Star size={12} fill="currentColor" />
            </div>
          </div>
        </div>
      </div>

      {/* Right Column: OAuth Login Interface */}
      <div className="flex-1 flex flex-col justify-center p-6 sm:p-12 lg:p-24 relative">
        <div className="max-w-md w-full mx-auto">
          {/* Mobile Logo Only */}
          <div
            onClick={() => {
              router.push("/");
            }}
            className="cursor-pointer lg:hidden flex items-center gap-2 mb-12"
          >
            <div className="w-8 h-8 bg-[oklch(64%_0.24_274)] rounded-lg flex items-center justify-center shadow-lg">
              <Zap className="w-4 h-4 text-white fill-current" />
            </div>
            <span className="text-xl font-black tracking-tighter">
              XP<span className="text-[oklch(64%_0.24_274)]">LOCAL</span>
            </span>
          </div>

          <div className="mb-12">
            <h1 className="text-4xl font-black mb-3 tracking-tight">
              Customer Sign In
            </h1>
            <p className="opacity-60 font-medium text-lg leading-relaxed">
              For your security, we use verified social authentication to manage
              your venue.
            </p>
          </div>

          <div className="space-y-4">
            {/* Google OAuth Button */}
            <button
              onClick={() => handleOAuthClick("google")}
              disabled={isLoading}
              className="w-full group flex items-center justify-between px-8 py-5 bg-white dark:bg-[oklch(22%_0.03_260)] border-2 border-neutral-100 dark:border-neutral-800 rounded-[2rem] hover:border-[oklch(64%_0.24_274)] transition-all active:scale-[0.98] disabled:opacity-50"
            >
              <div className="flex items-center gap-4">
                <Chrome size={24} className="text-[oklch(64%_0.24_274)]" />
                <span className="font-black text-lg">Continue with Google</span>
              </div>
              <ArrowRight className="w-5 h-5 opacity-0 group-hover:opacity-100 group-hover:translate-x-1 transition-all" />
            </button>
          </div>

          <p className="mt-12 text-center text-xs font-bold opacity-30 uppercase tracking-[0.2em]">
            Secure Portal for Customers
          </p>
        </div>

        {/* Status Bar */}
        <div className="mt-auto pt-10 text-center lg:text-left flex items-center justify-center lg:justify-start gap-4">
          <button className="inline-flex items-center gap-2 text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 transition-opacity">
            <ShieldCheck size={14} /> Encrypted Session
          </button>
          <span className="w-1 h-1 rounded-full bg-neutral-300 dark:bg-neutral-700"></span>
          <button className="text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 transition-opacity">
            Support: v2.0.4
          </button>
        </div>
      </div>

      <style
        dangerouslySetInnerHTML={{
          __html: `
        @import "tailwindcss";

        @theme {
          --color-primary: oklch(64% 0.24 274);
          --color-accent: oklch(88% 0.19 118);
          --color-reward: oklch(84% 0.17 75);
          --color-neutral-50: oklch(99% 0.005 60);
          --color-neutral-950: oklch(14% 0.02 260);

          --color-background: var(--color-neutral-50);
          --color-foreground: oklch(20% 0.05 260);
        }

        .dark {
          --color-background: var(--color-neutral-950);
          --color-foreground: oklch(92% 0.02 260);
        }

        @media (prefers-color-scheme: dark) {
          :root:not(.light) {
            --color-background: var(--color-neutral-950);
            --color-foreground: oklch(92% 0.02 260);
          }
        }

        :root {
          --background: var(--color-background);
          --foreground: var(--color-foreground);
        }

        body {
          background: var(--background);
          color: var(--foreground);
        }

        @keyframes pulse-slow {
          0%, 100% { opacity: 0.15; }
          50% { opacity: 0.25; }
        }
        .animate-pulse {
          animation: pulse-slow 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
      `,
        }}
      />
    </div>
  );
};

export default App;


--- FILE: src/app/[venueId]/layout.js ---
"use client";

import { useEffect, useState } from "react";
import { createClient } from "@/utils/supabase/client";
import CustomerNav from "./components/CustomerNav";
import AuthModal from "./components/AuthModal";

export default function CustomerLayout({ children }) {
  const supabase = createClient();
  const [venue, setVenue] = useState({ name: "Loading...", slug: "loading" });
  const [user, setUser] = useState(null);
  const [isAuthOpen, setIsAuthOpen] = useState(false);

  useEffect(() => {
    const getBranding = async () => {
      // 1. Check for logged in user
      const {
        data: { user: authUser },
      } = await supabase.auth.getUser();
      setUser(authUser);

      // 2. Fetch the venue branding
      // In a real app, you'd fetch by the slug in the URL
      const { data: venueData } = await supabase
        .from("venues")
        .select("*")
        .single();
      if (venueData) setVenue(venueData);
    };

    getBranding();
  }, [supabase]);

  return (
    <div className="min-h-screen bg-[oklch(98%_0.01_200)] text-dark font-sans antialiased pb-24">
      {/* Dynamic Branding Header */}
      <header className="bg-white border-b border-neutral-100 p-6 flex justify-between items-center sticky top-0 z-50">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-[oklch(64%_0.24_274)] rounded-xl flex items-center justify-center text-white shadow-lg overflow-hidden">
            {venue.logo_url ? (
              <img
                src={venue.logo_url}
                alt={venue.name}
                className="w-full h-full object-cover"
              />
            ) : (
              <span className="font-black italic text-lg">{venue.name[0]}</span>
            )}
          </div>
          <div>
            <h1 className="font-black text-sm tracking-tight leading-none uppercase italic">
              {venue.name}
            </h1>
            <p className="text-[9px] font-bold opacity-30 uppercase tracking-widest mt-1">
              XP Marketplace
            </p>
          </div>
        </div>

        {/* Dynamic Auth Button */}
        {!user ? (
          <button
            onClick={() => setIsAuthOpen(true)}
            className="bg-[oklch(64%_0.24_274)]/5 px-4 py-2 rounded-lg"
          >
            <span className="text-[10px] font-black text-[oklch(64%_0.24_274)] uppercase">
              Sign In
            </span>
          </button>
        ) : (
          <div className="w-8 h-8 rounded-full border-2 border-[oklch(64%_0.24_274)] overflow-hidden">
            <img src={user.user_metadata.avatar_url} alt="Profile" />
          </div>
        )}
      </header>

      <main className="max-w-md mx-auto px-6 py-6">{children}</main>

      <CustomerNav />
      <AuthModal isOpen={isAuthOpen} onClose={() => setIsAuthOpen(false)} />

      <style
        dangerouslySetInnerHTML={{
          __html: `
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
      `,
        }}
      />
    </div>
  );
}


--- FILE: src/app/[venueId]/page.js ---
"use client";

import React, { useState, useEffect, useCallback } from "react";
import { createClient } from "@/utils/supabase/client";
import {
  Zap,
  ShoppingBag,
  Coffee,
  Sparkles,
  Gift,
  Percent,
  Star,
  IceCream,
  Loader2,
} from "lucide-react";
import SaveXPBanner from "./components/SaveXPBanner";
import AuthModal from "./components/AuthModal";

// Helper to map generic icons to reward labels
const getIcon = (label) => {
  const l = label.toLowerCase();
  if (l.includes("coffee") || l.includes("drink")) return Coffee;
  if (l.includes("cupcake") || l.includes("treat")) return Gift;
  if (l.includes("off") || l.includes("%")) return Percent;
  if (l.includes("review")) return Star;
  return Sparkles;
};

export default function CustomerMarketplace() {
  const supabase = createClient();
  const [isAuthOpen, setIsAuthOpen] = useState(false);
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState(null);
  const [balance, setBalance] = useState(0);
  const [rewards, setRewards] = useState([]);

  const fetchData = useCallback(async () => {
    const {
      data: { user: authUser },
    } = await supabase.auth.getUser();
    setUser(authUser);

    // Fetch the specific venue marketplace (Assuming one venue for MVP)
    const { data: venueData } = await supabase
      .from("venues")
      .select("id")
      .single();

    if (venueData) {
      const [balRes, rewardRes] = await Promise.all([
        authUser
          ? supabase
              .from("balances")
              .select("xp_amount")
              .eq("user_id", authUser.id)
              .eq("venue_id", venueData.id)
              .single()
          : { data: { xp_amount: 50 } },
        supabase
          .from("rewards")
          .select("*")
          .eq("venue_id", venueData.id)
          .eq("is_active", true),
      ]);

      setBalance(balRes.data?.xp_amount || 0);
      setRewards(rewardRes.data || []);
    }
    setLoading(false);
  }, [supabase]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // Handle Reward Purchase
  const handlePurchase = async (reward) => {
    if (!user) return setIsAuthOpen(true);
    if (balance < reward.cost) return alert("Not enough XP!");

    const code = Math.random().toString(36).substring(2, 8).toUpperCase();

    try {
      // 1. Deduct Balance
      const { error: balErr } = await supabase.rpc("deduct_xp", {
        user_id_input: user.id,
        venue_id_input: reward.venue_id,
        amount: reward.cost,
      });
      if (balErr) throw balErr;

      // 2. Create Redemption Record
      await supabase.from("redemptions").insert([
        {
          user_id: user.id,
          venue_id: reward.venue_id,
          reward_id: reward.id,
          code: code,
          status: "active",
        },
      ]);

      // 3. Log Activity
      await supabase.from("activity_logs").insert([
        {
          venue_id: reward.venue_id,
          user_id: user.id,
          display_name: user.user_metadata.full_name,
          action_name: reward.label.toUpperCase(),
          xp_change: -reward.cost,
        },
      ]);

      setBalance((prev) => prev - reward.cost);
      alert(`Redemption Code: ${code}. Find it in "My Codes".`);
    } catch (err) {
      alert("Error: " + err.message);
    }
  };

  if (loading)
    return (
      <div className="h-screen flex items-center justify-center">
        <Loader2 className="animate-spin opacity-20" />
      </div>
    );

  return (
    <div className="relative min-h-screen pb-24 px-6">
      {/* 1. WALLET SECTION */}
      <section className="mb-8 pt-6">
        <div className="bg-neutral-800 p-8 rounded-[2.5rem] text-neutral-50 shadow-2xl relative overflow-hidden border border-neutral-700">
          <div className="relative z-10 space-y-1">
            <p className="text-[10px] font-black uppercase tracking-[0.3em] opacity-40 italic">
              {user ? "Your Balance" : "Guest Balance"}
            </p>
            <div className="flex items-end gap-2">
              <h2 className="text-6xl font-black italic tracking-tighter leading-none">
                {balance}
              </h2>
              <span className="text-[oklch(88%_0.19_118)] font-black text-xl mb-1.5 italic tracking-tighter uppercase">
                XP
              </span>
            </div>
          </div>
          <Zap
            className="absolute -right-10 -bottom-10 text-neutral-50/5 w-44 h-44"
            strokeWidth={1}
          />
        </div>
      </section>

      {/* 2. SHOP GRID */}
      <section className="space-y-6">
        <div className="flex justify-between items-center px-2">
          <h3 className="text-[10px] font-black uppercase tracking-[0.3em] opacity-30 italic flex items-center gap-2">
            <ShoppingBag size={14} /> Marketplace
          </h3>
        </div>

        <div className="grid grid-cols-2 gap-3">
          {rewards.map((item, index) => {
            const Icon = getIcon(item.label);
            const canAfford = balance >= item.cost;
            return (
              <button
                key={item.id}
                onClick={() => handlePurchase(item)}
                className={`p-5 rounded-[2rem] border shadow-sm text-left relative overflow-hidden active:scale-95 transition-all group animate-in ${
                  !canAfford && user
                    ? "opacity-50 grayscale"
                    : "bg-white border-neutral-100"
                }`}
                style={{ animationDelay: `${index * 40}ms` }}
              >
                <div
                  className={`w-10 h-10 rounded-xl flex items-center justify-center text-white mb-4 shadow-md bg-[oklch(64%_0.24_274)]`}
                >
                  <Icon size={18} strokeWidth={2.5} />
                </div>
                <div className="font-black text-[13px] tracking-tight leading-tight mb-1 uppercase">
                  {item.label}
                </div>
                <div className="text-[10px] font-black text-[oklch(64%_0.24_274)] uppercase">
                  {item.cost} XP
                </div>
              </button>
            );
          })}
        </div>
      </section>

      {/* 3. FLOATING BANNER */}
      {!user && (
        <div className="fixed bottom-24 left-6 right-6 z-40">
          <SaveXPBanner onClick={() => setIsAuthOpen(true)} />
        </div>
      )}

      <AuthModal isOpen={isAuthOpen} onClose={() => setIsAuthOpen(false)} />
    </div>
  );
}


--- FILE: src/app/[venueId]/earn/page.js ---
"use client";

import React, { useState, useEffect, useCallback } from "react";
import { useParams } from "next/navigation";
import { createClient } from "@/utils/supabase/client";
import {
  Star,
  Instagram,
  Users,
  Calendar,
  Loader2,
  MessageSquare,
  Smartphone,
  Share2,
  CheckCircle2,
} from "lucide-react";

const ICON_MAP = {
  google_review: Star,
  ig_follow: Instagram,
  sms_signup: MessageSquare,
  referral: Users,
  recurring: Calendar,
  default: Smartphone,
};

export default function EarnPage() {
  const { venueId } = useParams(); // Retrieves UUID from /[venueId]/earn
  const supabase = createClient();
  const [tasks, setTasks] = useState([]);
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [copiedId, setCopiedId] = useState(null);

  const loadEarnData = useCallback(async () => {
    try {
      const {
        data: { user: authUser },
      } = await supabase.auth.getUser(); //
      setUser(authUser);

      if (venueId) {
        // Fetch tasks using the venueId directly
        const { data: venueTasks } = await supabase
          .from("earning_tasks")
          .select("*")
          .eq("venue_id", venueId)
          .eq("is_active", true);

        setTasks(venueTasks || []);
      }
    } catch (err) {
      console.error("Error loading earn page:", err);
    } finally {
      setLoading(false);
    }
  }, [supabase, venueId]);

  useEffect(() => {
    loadEarnData();
  }, [loadEarnData]);

  const handleSocialClick = async (task) => {
    if (!task.target_url) return;
    window.open(task.target_url, "_blank");

    if (user) {
      await supabase.from("activity_logs").insert([
        {
          venue_id: venueId,
          user_id: user.id,
          display_name: user.user_metadata.full_name,
          action_name: task.label.toUpperCase(),
          xp_change: task.xp_reward,
        },
      ]); //
    }
  };

  const handleReferralShare = async (task) => {
    if (!user) {
      alert("Please sign in to generate your link!");
      return;
    }

    // Referral link now uses the venueId UUID instead of a slug
    const referralLink = `${window.location.origin}/venue/${venueId}?ref=${user.id}`;

    try {
      await navigator.clipboard.writeText(referralLink); //
      setCopiedId(task.id);
      setTimeout(() => setCopiedId(null), 2000);

      await supabase.from("activity_logs").insert([
        {
          venue_id: venueId,
          user_id: user.id,
          display_name: user.user_metadata.full_name,
          action_name: "COPIED REFERRAL LINK",
          xp_change: 0,
        },
      ]); //
    } catch (err) {
      console.error("Failed to copy:", err);
    }
  };

  if (loading)
    return (
      <div className="h-96 flex items-center justify-center">
        <Loader2 className="animate-spin opacity-10" size={32} />
      </div>
    );

  return (
    <div className="space-y-8 animate-pop p-6">
      <header>
        <h1 className="text-3xl font-black italic tracking-tighter uppercase leading-none">
          Earn <span className="text-[oklch(64%_0.24_274)]">XP.</span>
        </h1>
        <p className="text-[10px] font-black uppercase tracking-widest opacity-30 mt-2">
          Complete tasks to fill your wallet
        </p>
      </header>

      <div className="space-y-3">
        {tasks.map((t) => {
          const Icon = ICON_MAP[t.action_type] || ICON_MAP.default;
          const isReferral = t.action_type === "referral";
          const isRecurring = t.action_type === "recurring";

          return (
            <button
              key={t.id}
              onClick={() => {
                if (isReferral) handleReferralShare(t);
                else if (!isRecurring) handleSocialClick(t);
              }}
              className={`w-full bg-white p-6 rounded-[2rem] border border-neutral-100 flex items-center justify-between active:scale-95 transition-all group shadow-sm ${
                isRecurring ? "cursor-default" : "cursor-pointer"
              }`}
            >
              <div className="flex items-center gap-4 text-left">
                <div
                  className={`p-3 rounded-xl transition-colors ${
                    isReferral && copiedId === t.id
                      ? "bg-[oklch(88%_0.19_118)] text-black"
                      : "bg-neutral-50 text-[oklch(64%_0.24_274)] group-hover:bg-[oklch(64%_0.24_274)] group-hover:text-white"
                  }`}
                >
                  {isReferral && copiedId === t.id ? (
                    <CheckCircle2 size={20} />
                  ) : (
                    <Icon size={20} />
                  )}
                </div>
                <div>
                  <div className="font-black text-sm leading-tight uppercase">
                    {t.label}
                  </div>
                  <div className="text-[9px] font-bold opacity-30 uppercase tracking-widest mt-0.5">
                    {isReferral
                      ? "Copy Invitation Link"
                      : isRecurring
                      ? "Scan Store QR"
                      : "Click to Verify"}
                  </div>
                </div>
              </div>
              <div className="text-xs font-black text-[oklch(88%_0.19_118)]">
                +{t.xp_reward} XP
              </div>
            </button>
          );
        })}
      </div>

      <div className="bg-neutral-800 p-8 rounded-[2.5rem] text-white relative overflow-hidden shadow-xl">
        <div className="relative z-10">
          <div className="flex items-center gap-2 text-[oklch(88%_0.19_118)] mb-2">
            <Share2 size={16} />
            <span className="text-[9px] font-black uppercase tracking-[0.2em]">
              Referral System
            </span>
          </div>
          <h3 className="text-xl font-black italic uppercase leading-tight mb-2">
            Bring a <span className="text-[oklch(88%_0.19_118)]">Friend.</span>
          </h3>
          <p className="text-[10px] font-bold opacity-50 uppercase leading-relaxed max-w-[200px]">
            Share your link and get XP when they physically visit the store for
            the first time.
          </p>
        </div>
        <Users className="absolute -right-6 -bottom-6 w-32 h-32 text-white/5" />
      </div>
    </div>
  );
}


--- FILE: src/app/[venueId]/components/AuthModal.js ---
"use client";

import React, { useState, useEffect } from "react";
import { Zap, ShieldCheck } from "lucide-react";

export default function AuthModal({ isOpen, onClose }) {
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    // Putting this in a timeout moves it to the next task in the event loop
    // This stops the "Cascading Render" warning dead in its tracks.
    const timer = setTimeout(() => {
      setMounted(true);
    }, 0);
    return () => clearTimeout(timer);
  }, []);

  // Only render if we've cleared the mount and the parent wants it open
  if (!mounted || !isOpen) return null;

  return (
    <div className="fixed inset-0 z-[100] flex items-end sm:items-center justify-center p-0 sm:p-4">
      <div
        className="absolute inset-0 bg-neutral-950/40 backdrop-blur-md"
        onClick={onClose}
      />

      <div className="relative w-full max-w-md bg-surface rounded-t-[3rem] sm:rounded-[3rem] p-8 pb-12 shadow-2xl animate-in slide-in-from-bottom border-t border-x border-border">
        {/* Close Button: Reminding them of the value */}
        <button
          onClick={onClose}
          className="absolute right-6 top-6 px-4 py-2 bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 text-foreground/40 hover:text-foreground rounded-full transition-all flex items-center gap-2 group"
        >
          <span className="text-[10px] font-black uppercase tracking-widest leading-none">
            XP Earned
          </span>
          <div className="w-4 h-4 rounded-full bg-foreground/10 flex items-center justify-center group-hover:bg-red-500 group-hover:text-white transition-all text-[8px] font-bold">
            ✕
          </div>
        </button>

        <div className="space-y-8 pt-6">
          <div className="w-16 h-16 bg-primary rounded-2xl flex items-center justify-center text-neutral-50 shadow-xl shadow-primary/20">
            <Zap size={32} fill="currentColor" />
          </div>

          <div className="space-y-2">
            <h2 className="text-3xl font-black italic tracking-tighter uppercase leading-tight">
              Save your <span className="text-primary">Progress.</span>
            </h2>
            <p className="text-[11px] font-bold opacity-40 uppercase tracking-widest italic leading-relaxed">
              Sign in with Google to secure your wallet <br /> and keep your
              scan bonus.
            </p>
          </div>

          {/* Google Button */}
          <button className="w-full py-5 bg-white text-neutral-800 rounded-[1.5rem] font-black uppercase tracking-widest shadow-xl border border-neutral-200 hover:bg-neutral-50 transition-all flex items-center justify-center gap-4 group active:scale-[0.98]">
            <svg className="w-5 h-5" viewBox="0 0 24 24">
              <path
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                fill="#4285F4"
              />
              <path
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                fill="#34A853"
              />
              <path
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                fill="#FBBC05"
              />
              <path
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                fill="#EA4335"
              />
            </svg>
            Continue with Google
          </button>
        </div>
      </div>
    </div>
  );
}


--- FILE: src/app/[venueId]/components/SaveXPBanner.js ---
"use client";
import React from "react";
import { Zap, ArrowRight } from "lucide-react";

export default function SaveXPBanner({ onClick }) {
  return (
    <button
      onClick={onClick}
      className="w-full bg-accent text-neutral-950 p-5 rounded-[2rem] shadow-2xl shadow-accent/20 flex items-center justify-between border-b-4 border-accent-600 active:scale-95 transition-all group"
    >
      <div className="flex items-center gap-4">
        <div className="bg-neutral-950 p-2.5 rounded-xl text-accent">
          <Zap size={18} fill="currentColor" />
        </div>
        <div className="text-left">
          <p className="text-[10px] font-black uppercase tracking-[0.2em] leading-none opacity-50 mb-1">
            +50 XP Earned
          </p>
          <p className="text-sm font-black tracking-tight">
            Save your progress now
          </p>
        </div>
      </div>
      <div className="bg-neutral-950/10 p-2.5 rounded-full group-hover:bg-neutral-950 group-hover:text-accent transition-all">
        <ArrowRight size={20} />
      </div>
    </button>
  );
}


--- FILE: src/app/[venueId]/components/CustomerNav.js ---
"use client";

import React, { useState, useEffect } from "react";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { ShoppingBag, Zap, Ticket } from "lucide-react";

export default function CustomerNav() {
  const pathname = usePathname();
  const [mounted, setMounted] = useState(false);

  // Extract venueId from path (e.g., /cafe-local/earn -> cafe-local)
  const venueId = pathname.split("/")[1] || "venue";

  useEffect(() => {
    // Timeout breaks the synchronous render chain to prevent hydration warnings
    const timer = setTimeout(() => {
      setMounted(true);
    }, 0);
    return () => clearTimeout(timer);
  }, []);

  const tabs = [
    { label: "Earn", icon: Zap, path: `/${venueId}/earn` },
    { label: "Shop", icon: ShoppingBag, path: `/${venueId}` },
    { label: "Codes", icon: Ticket, path: `/${venueId}/codes` },
  ];

  // Render an empty bar during SSR to prevent layout shift without triggering errors
  if (!mounted) {
    return (
      <nav className="fixed bottom-0 left-0 right-0 bg-surface/80 backdrop-blur-xl border-t border-border px-8 py-4 z-50 h-[72px]" />
    );
  }

  return (
    <nav className="fixed bottom-0 left-0 right-0 bg-surface/80 backdrop-blur-xl border-t border-border px-8 py-4 z-50">
      <div className="max-w-md mx-auto flex justify-between items-center">
        {tabs.map((tab) => {
          // Logic to handle active state for the Shop (root venue path)
          const isActive =
            tab.label === "Shop"
              ? pathname === `/${venueId}`
              : pathname === tab.path;

          return (
            <Link
              key={tab.label}
              href={tab.path}
              className={`flex flex-col items-center gap-1 transition-all active:scale-90 ${
                isActive ? "text-primary" : "text-foreground/20"
              }`}
            >
              <div className="relative">
                <tab.icon
                  size={22}
                  strokeWidth={isActive ? 3 : 2}
                  className={
                    isActive ? "drop-shadow-[0_0_8px_rgba(154,71,255,0.3)]" : ""
                  }
                />
                {isActive && (
                  <div className="absolute -top-1 -right-1 w-1.5 h-1.5 bg-accent rounded-full border border-surface" />
                )}
              </div>
              <span className="text-[9px] font-black uppercase tracking-[0.15em]">
                {tab.label}
              </span>
            </Link>
          );
        })}
      </div>
    </nav>
  );
}


--- FILE: src/app/[venueId]/codes/page.js ---
"use client";

import React, { useState, useEffect, useCallback } from "react";
import { createClient } from "@/utils/supabase/client";
import { formatDistanceToNow } from "date-fns"; // Consistent with your FeedPage
import { Ticket, Clock, Loader2 } from "lucide-react";

export default function MyCodesPage() {
  const supabase = createClient();
  const [codes, setCodes] = useState([]);
  const [loading, setLoading] = useState(true);

  const fetchMyCodes = useCallback(async () => {
    try {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) return;

      // Fetch redemptions joined with reward labels
      const { data, error } = await supabase
        .from("redemptions")
        .select(
          `
          id,
          code,
          status,
          created_at,
          redeemed_at,
          rewards (label)
        `
        )
        .eq("user_id", user.id)
        .order("created_at", { ascending: false });

      if (error) throw error;
      setCodes(data || []);
    } catch (err) {
      console.error("Error fetching codes:", err.message);
    } finally {
      setLoading(false);
    }
  }, [supabase]);

  useEffect(() => {
    fetchMyCodes();
  }, [fetchMyCodes]);

  if (loading)
    return (
      <div className="h-96 flex items-center justify-center">
        <Loader2 className="animate-spin opacity-10" size={32} />
      </div>
    );

  return (
    <div className="space-y-8 animate-pop">
      <h1 className="text-3xl font-black italic tracking-tighter uppercase leading-none">
        My <span className="text-[oklch(64%_0.24_274)]">Codes.</span>
      </h1>

      <div className="space-y-4">
        {codes.length > 0 ? (
          codes.map((c) => {
            const isActive = c.status === "active";
            // Logic: Show distance to now for active, or the specific redeemed date
            const timeLabel = isActive
              ? `${formatDistanceToNow(new Date(c.created_at))} ago`
              : `Used ${new Date(c.redeemed_at).toLocaleDateString()}`;

            return (
              <div
                key={c.id}
                className={`relative overflow-hidden rounded-[2rem] border transition-all ${
                  isActive
                    ? "bg-white border-neutral-100 shadow-lg"
                    : "opacity-40 grayscale bg-neutral-100"
                }`}
              >
                {/* Visual Ticket Notches */}
                <div className="absolute -left-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-[oklch(98%_0.01_200)] rounded-full border border-neutral-100" />
                <div className="absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-[oklch(98%_0.01_200)] rounded-full border border-neutral-100" />

                <div className="p-8 flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div
                      className={`p-4 rounded-2xl ${
                        isActive
                          ? "bg-[oklch(64%_0.24_274)] text-white"
                          : "bg-neutral-200"
                      }`}
                    >
                      <Ticket size={24} />
                    </div>
                    <div>
                      <h3 className="font-black text-sm leading-none mb-1 uppercase">
                        {c.rewards?.label || "Unknown Reward"}
                      </h3>
                      <div className="flex items-center gap-1 text-[9px] font-bold opacity-30 uppercase">
                        <Clock size={10} /> {timeLabel}
                      </div>
                    </div>
                  </div>
                  <div
                    className={`text-2xl font-black tracking-[0.2em] ${
                      isActive
                        ? "text-[oklch(64%_0.24_274)]"
                        : "text-neutral-400"
                    }`}
                  >
                    {isActive ? c.code : "USED"}
                  </div>
                </div>
              </div>
            );
          })
        ) : (
          <div className="py-20 text-center opacity-20 font-black uppercase tracking-widest text-[10px]">
            No codes generated yet
          </div>
        )}
      </div>
    </div>
  );
}


